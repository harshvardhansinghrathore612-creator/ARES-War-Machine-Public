name: ARES War Machine - Manual Absolute 100%
on:
  workflow_dispatch:

jobs:
  security-hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_PAT }}

      - name: "Environment & Core Installation"
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip golang-go default-jre zip curl wget git libpcap-dev ruby-full chromium chromium-driver xvfb libcurl4-openssl-dev libxml2-dev libxslt1-dev
          mkdir -p $HOME/bin $HOME/tools output/recon output/probing output/screenshots output/crawling output/secrets output/sqlmap output/commix output/vulns output/specialized
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          pip3 install google-api-python-client google-auth-httplib2 google-auth-oauthlib

          # TOOLS (No Amass as requested)
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest || true
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest || true
          go install -v github.com/projectdiscovery/katana/cmd/katana@latest || true
          go install -v github.com/lc/gau/v2/cmd/gau@latest || true
          go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest || true
          go install -v github.com/hahwul/dalfox/v2@latest || true
          go install -v github.com/sensepost/gowitness@latest || true
          
          pip3 install sqlmap arjun wfuzz gitleaks trufflehog s3scanner commix ghauri nosqlmap waymore jsluice jwt_tool kiterunner wpscan eyewitness || true
          
          git clone https://github.com/m4ll0k/SecretFinder.git $HOME/tools/SecretFinder && pip3 install -r $HOME/tools/SecretFinder/requirements.txt || true
          git clone https://github.com/1N3/LinkFinder.git $HOME/tools/LinkFinder && pip3 install -r $HOME/tools/LinkFinder/requirements.txt || true
          git clone https://github.com/tarunkant/Gopherus.git $HOME/tools/Gopherus || true
          
          wget https://raw.githubusercontent.com/haccer/subjack/master/fingerprints.json -O $HOME/tools/fingerprints.json

      - name: "ARES Execution Engine"
        env:
          GDRIVE_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
          FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          TARGET=$(cat targets.txt | head -n 1)
          
          # FIXED UPLOADER: Bypasses the Service Account 0GB limit
          cat << 'EOF' > live_sync_drive.py
          import os, sys, json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          def get_service():
              creds = service_account.Credentials.from_service_account_info(json.loads(os.environ['GDRIVE_JSON']))
              return build('drive', 'v3', credentials=creds)

          def get_or_create_folder(service, name, parent_id):
              query = f"name = '{name}' and '{parent_id}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false"
              files = service.files().list(q=query, supportsAllDrives=True, includeItemsFromAllDrives=True).execute().get('files', [])
              if not files:
                  body = {'name': name, 'parents': [parent_id], 'mimeType': 'application/vnd.google-apps.folder'}
                  return service.files().create(body=body, fields='id', supportsAllDrives=True).execute().get('id')
              return files[0].get('id')

          def upload_content(path, drive_parent_id, target_name):
              service = get_service()
              target_folder = get_or_create_folder(service, target_name, drive_parent_id)
              
              if os.path.isfile(path):
                  media = MediaFileUpload(path, resumable=True)
                  # FIX: We use 'fields=id' and 'supportsAllDrives=True' while ensuring 
                  # the file is created inside the shared folder you shared with the bot.
                  service.files().create(
                      body={'name': os.path.basename(path), 'parents': [target_folder]},
                      media_body=media,
                      supportsAllDrives=True
                  ).execute()
              elif os.path.isdir(path):
                  tool_folder = get_or_create_folder(service, os.path.basename(path), target_folder)
                  for root, _, files in os.walk(path):
                      for file in files:
                          f_path = os.path.join(root, file)
                          media = MediaFileUpload(f_path, resumable=True)
                          service.files().create(
                              body={'name': file, 'parents': [tool_folder]},
                              media_body=media,
                              supportsAllDrives=True
                          ).execute()
          
          if __name__ == "__main__":
              upload_content(sys.argv[1], sys.argv[2], sys.argv[3])
          EOF

          send_msg() {
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" -d parse_mode="Markdown" -d text="$1"
          }

          # --- EXECUTION ---
          send_msg "üöÄ *ARES Started:* \`$TARGET\`"

          # STAGE 1
          subfinder -d $TARGET -o output/recon/subs.txt
          python3 live_sync_drive.py "output/recon/subs.txt" "$FOLDER_ID" "$TARGET"

          # STAGE 2
          httpx -l output/recon/subs.txt -o output/probing/live.txt
          xvfb-run gowitness file -f output/probing/live.txt --screenshot-path output/screenshots/ || true
          python3 live_sync_drive.py "output/probing" "$FOLDER_ID" "$TARGET"
          python3 live_sync_drive.py "output/screenshots" "$FOLDER_ID" "$TARGET"

          # STAGE 3
          katana -list output/probing/live.txt -o output/crawling/urls.txt
          python3 live_sync_drive.py "output/crawling" "$FOLDER_ID" "$TARGET"

          # STAGE 4
          nuclei -l output/probing/live.txt -o output/vulns/nuclei_results.txt || true
          python3 live_sync_drive.py "output/vulns" "$FOLDER_ID" "$TARGET"

      - name: "Final Notification"
        if: always()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" -d text="üèÅ **ARES Manual Run Finished.**"
          rm -rf output/
          
