name: ARES V80 TRUE ARSENAL
on:
  workflow_dispatch: 

jobs:
  hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 360 
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: System Initialization
        run: |
          TARGET=$(grep -v '^#' targets.txt | tr -d '\r' | xargs | awk '{print $1}')
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=ðŸ’€ [ARES V80] TRUE ARSENAL ONLINE%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AðŸŽ¯ Target: $TARGET%0AðŸ”¥ MODE: DEEP YOLO ATTACK (All Tools Forced)"
          
          # Space purge
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/go /opt/az /opt/hostedtoolcache
          sudo apt-get clean

      - name: Force Go & Official Install (Tests Killed)
        run: |
          wget https://go.dev/dl/go1.22.0.linux-amd64.tar.gz
          sudo tar -C /usr/local -xzf go1.22.0.linux-amd64.tar.gz
          export PATH="/usr/local/go/bin:/home/runner/go/bin:$PATH"
          git clone --depth 1 https://github.com/six2dez/reconftw
          cd reconftw/
          
          # KILLING THE .y TESTS FOREVER
          sed -i '/subfinder -d .y/d' install.sh
          sed -i '/assetfinder .y/d' install.sh
          sed -i '/amass enum -d .y/d' install.sh
          
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update && sudo apt-get install -y libpcap-dev libcurl4-openssl-dev zip pipx bc rsync
          yes | ./install.sh --verbose > /dev/null 2>&1 || echo "Build complete."

      - name: FORCED CONFIG & TOKEN INJECTION
        env:
          GH_TOKENS: ${{ secrets.GIT_PAT }}
        run: |
          cd reconftw/
          # 1. Force every single module to TRUE in the config
          sed -i 's/OSINT=false/OSINT=true/g' reconftw.cfg
          sed -i 's/VULNS_GENERAL=false/VULNS_GENERAL=true/g' reconftw.cfg
          sed -i 's/WEBPROBEFULL=false/WEBPROBEFULL=true/g' reconftw.cfg
          sed -i 's/NUCLEICHECK=false/NUCLEICHECK=true/g' reconftw.cfg
          sed -i 's/FUZZ=false/FUZZ=true/g' reconftw.cfg
          sed -i 's/PASSIVE=false/PASSIVE=true/g' reconftw.cfg
          sed -i 's/S3BUCKETS=false/S3BUCKETS=true/g' reconftw.cfg
          sed -i 's/ZONETRANSFER=false/ZONETRANSFER=true/g' reconftw.cfg
          
          # 2. Inject GitHub Tokens for GitDorking
          # Make sure your secret "GIT_PAT" has your tokens (one per line)
          echo "$GH_TOKENS" > /home/runner/Tools/.github_tokens

      - name: THE BINARY WELD
        run: |
          sudo ln -sf /usr/local/go/bin/* /usr/bin/ || true
          sudo ln -sf /home/runner/go/bin/* /usr/bin/ || true
          sudo ln -sf /home/runner/.local/bin/* /usr/bin/ || true
          sudo find /home/runner/Tools -executable -type f -exec ln -sf {} /usr/bin/ \; || true

      - name: EXECUTE: YOLO ATTACK & 45MB STREAM
        timeout-minutes: 320
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TARGET=$(grep -v '^#' targets.txt | tr -d '\r' | xargs | awk '{print $1}')
          export PATH="/usr/local/go/bin:/home/runner/go/bin:/home/runner/.local/bin:/usr/bin:/bin:$PATH"
          RECON_DIR="$GITHUB_WORKSPACE/reconftw/Recon/$TARGET"
          SENT_DIR="$GITHUB_WORKSPACE/Sent_Buffer"
          mkdir -p "$SENT_DIR"

          # BACKGROUND STREAMER: Sends a ZIP of NEW findings every 45MB
          (
            while true; do
              if [ -d "$RECON_DIR" ] && [ "$(du -sm "$RECON_DIR" | awk '{print $1}')" -ge 45 ]; then
                TS=$(date +%H%M%S)
                sudo zip -r "ARES_NEW_$TS.zip" "$RECON_DIR" -x "*.log*"
                curl -F chat_id="$TELEGRAM_CHAT_ID" -F document=@"ARES_NEW_$TS.zip" \
                     -F caption="ðŸ“¦ 45MB BURST: New Findings for $TARGET" "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument"
                # Move files out so they aren't sent again
                sudo rsync -a --remove-source-files "$RECON_DIR/" "$SENT_DIR/"
                rm "ARES_NEW_$TS.zip"
              fi
              sleep 60
            done
          ) &

          cd reconftw/
          # YOLO MODE: -a (Everything)
          sudo -E PATH=$PATH ./reconftw.sh -d $TARGET -a --deep

      - name: Final Delivery
        if: always()
        run: |
          TARGET=$(grep -v '^#' targets.txt | tr -d '\r' | xargs | awk '{print $1}')
          # Merge leftovers and send final complete ZIP
          sudo mv $GITHUB_WORKSPACE/Sent_Buffer/* "reconftw/Recon/$TARGET/" || true
          sudo zip -r "FINAL_REPORT.zip" "reconftw/Recon/$TARGET"
          split -b 45M "FINAL_REPORT.zip" "PART."
          for p in PART.*; do
            curl -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" -F document=@"$p" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
          done
