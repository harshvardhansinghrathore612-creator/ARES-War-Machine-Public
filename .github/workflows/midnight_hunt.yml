name: ARES V28 Absolute Stable
on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch: 

jobs:
  hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 360 
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. DISK PURGE: Shreds 30GB+ for maximum room
      - name: Maximize Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/local/go /usr/lib/jvm /usr/share/swift /usr/local/.ghcup /opt/az /usr/local/share/powershell /opt/hostedtoolcache
          sudo apt-get clean

      - name: Telegram Handshake
        run: |
          curl -s -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
               -F text="üöÄ [ARES V28] Stable Hunt Started: ${{ github.repository }}" \
               "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"

      # 2. FRESH INSTALL: No cache.
      - name: Install reconFTW
        run: |
          git clone --depth 1 https://github.com/six2dez/reconftw
          cd reconftw/ && ./install.sh

      # 3. CONFIG SURGERY: Skips the 30-minute HTTP Probing
      - name: Disable HTTP Probing
        run: |
          cd reconftw/
          sed -i 's/WEBPROBEFULL=true/WEBPROBEFULL=false/g' reconftw.cfg
          sed -i 's/WEBPROBESIMPLE=true/WEBPROBESIMPLE=false/g' reconftw.cfg

      # 4. PATH FIX: No symlinks. Just create the folders in the safe Home area
      - name: Setup Safe Environment
        run: |
          mkdir -p $HOME/.cache
          mkdir -p $HOME/.config
          mkdir -p $HOME/go
          chmod -R 777 $HOME

      # 5. EXECUTION: Using deep redirection to stop the Permission Denied errors
      - name: Execute Full Attack Suite
        timeout-minutes: 310
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_PAT }}
          # Forces tools to stay in the authorized /home/runner folder
          HOME: /home/runner
          XDG_CACHE_HOME: /home/runner/.cache
          XDG_CONFIG_HOME: /home/runner/.config
          GOPATH: /home/runner/go
        run: |
          TARGET=$(cat targets.txt)
          export PATH="$HOME/Tools:$HOME/go/bin:$PATH"
          cd reconftw/
          # Running as current user (no sudo) to keep environment variables active
          ./reconftw.sh -d $TARGET -r -a -s --deep
          
      # 6. MASTER ZIPPER: Checks if data exists before sending
      - name: Pack & Send Master Report
        if: always() 
        run: |
          TARGET=$(cat targets.txt)
          # DEBUG: Lists files so we can see if the folder is empty
          ls -R reconftw/Recon/$TARGET || echo "Folder is empty!"
          
          if [ -d "reconftw/Recon/$TARGET" ]; then
            zip -r "ARES_REPORT.zip" "reconftw/Recon/$TARGET"
            curl -v -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                 -F document=@"ARES_REPORT.zip" \
                 -F caption="‚úÖ DONE: $TARGET" \
                 "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
          else
             curl -s -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                  -F text="‚ùå CRITICAL ERROR: The scan produced NO DATA for $TARGET. Check GitHub logs for tool crashes." \
                  "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
          fi
          
