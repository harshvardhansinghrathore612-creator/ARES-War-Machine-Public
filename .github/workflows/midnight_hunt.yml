name: ARES V69 Command Center
on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch: 

jobs:
  hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 360 
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. THE SIGNAL: Instant confirmation that the machine is alive
      - name: Telegram: System Wake-Up
        run: |
          TARGET=$(grep -v '^#' targets.txt | tr -d '\r' | xargs | awk '{print $1}')
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚ö° [ARES V69] COMMAND CENTER ONLINE%0A‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0AüéØ Target: $TARGET%0AüèóÔ∏è Phase: System Initialization..."

      # 2. THE PURGE: Creating room for the heavy tools
      - name: Maximize Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/local/go /usr/lib/jvm /usr/share/swift /usr/local/.ghcup /opt/az /usr/local/share/powershell /opt/hostedtoolcache
          sudo apt-get clean

      # 3. GO-FORCE: Fixing GOROOT permanently
      - name: Force Official Go Installation
        run: |
          wget https://go.dev/dl/go1.22.0.linux-amd64.tar.gz
          sudo tar -C /usr/local -xzf go1.22.0.linux-amd64.tar.gz
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          echo "/home/runner/go/bin" >> $GITHUB_PATH
          echo "GOROOT=/usr/local/go" >> $GITHUB_ENV
          echo "GOPATH=/home/runner/go" >> $GITHUB_ENV

      # 4. OFFICIAL INSTALLER: Building the 94+ tool suite
      - name: Official reconFTW Installation
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üõ†Ô∏è Installing Official Toolchain... (20-25 mins)"
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update && sudo apt-get install -y libpcap-dev libcurl4-openssl-dev libxml2-dev libxslt1-dev python3-pip python3-dev zip pipx bc
          pipx ensurepath
          git clone --depth 1 https://github.com/six2dez/reconftw
          cd reconftw/ && chmod +x install.sh
          yes | ./install.sh --verbose

      # 5. THE BINARY WELD: Forcing tools into the system root
      - name: System Binary Weld
        run: |
          sudo ln -sf /usr/local/go/bin/* /usr/bin/ || true
          sudo ln -sf /home/runner/go/bin/* /usr/bin/ || true
          sudo ln -sf /home/runner/.local/bin/* /usr/bin/ || true
          sudo find /home/runner/Tools -executable -type f -exec ln -sf {} /usr/bin/ \; || true
          mkdir -p /home/runner/.cache /home/runner/.config
          sudo ln -sf /home/runner/.cache /.cache
          sudo ln -sf /home/runner/.config /.config
          sudo chmod -R 755 /home/runner
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚úÖ Toolchain Welded. Every tool is now visible to the scanner."

      # 6. LIVE-PULSE EXECUTION: Real-time feedback
      - name: Execute Full Attack Suite
        timeout-minutes: 320
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_PAT }}
          HOME: /home/runner
        run: |
          TARGET=$(grep -v '^#' targets.txt | tr -d '\r' | xargs | awk '{print $1}')
          export PATH="/usr/local/go/bin:/home/runner/go/bin:/home/runner/.local/bin:/usr/bin:/bin:$PATH"
          cd reconftw/
          
          # PULSE: Starting Recon
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üõ∞Ô∏è PHASE 1: Passive Reconnaissance Started for $TARGET"
          
          nuclei -ut || true
          sed -i 's/WEBPROBEFULL=false/WEBPROBEFULL=true/g' reconftw.cfg
          sed -i 's/NUCLEICHECK=false/NUCLEICHECK=true/g' reconftw.cfg
          
          # FORCED LOGGING: We run it as root and watch for the finish line
          sudo -E PATH=$PATH ./reconftw.sh -d $TARGET -r -a -s --deep && \
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üíÄ PHASE 2: Active Attacks Completed for $TARGET. Starting Report Zip..."

      # 7. SMART SPLIT-ZIPPER: Sending every part of the scan
      - name: Pack & Send Master Report
        if: always() 
        run: |
          TARGET=$(grep -v '^#' targets.txt | tr -d '\r' | xargs | awk '{print $1}')
          if [ -d "reconftw/Recon/$TARGET" ]; then
            FILE_COUNT=$(find "reconftw/Recon/$TARGET" -type f | wc -l)
            sudo zip -r "ARES_REPORT.zip" "reconftw/Recon/$TARGET"
            FILE_SIZE=$(stat -c%s "ARES_REPORT.zip")
            SIZE_MB=$(echo "scale=2; $FILE_SIZE/1024/1024" | bc)
            
            # Final Stats
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=üèÅ SCAN FINISHED%0A‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0ATarget: $TARGET%0AFiles: $FILE_COUNT%0ASize: ${SIZE_MB}MB%0A%0Aüì¶ Sending parts individually..."
            
            split -b 45M "ARES_REPORT.zip" "ARES_PART."
            for part in ARES_PART.*; do
              curl -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                   -F document=@"$part" \
                   -F caption="üì¶ Part $part for $TARGET" \
                   "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
              sleep 3
            done
          else
             curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
               -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
               -d "text=‚ùå FATAL ERROR: No results directory found for $TARGET. Check logs for tool crashes."
          fi
          
