name: ARES â€“ Multi-Tool Vulnerability Scanner

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Comma-separated tools OR "all"'
        required: true
        default: 'all'
        type: string
      target:
        description: 'Target(s)'
        required: true
        type: string
      previous_run_id:
        description: 'Chain Artifacts from Run ID'
        required: false
        type: string

env:
  GOPATH: /home/runner/go
  GO111MODULE: "on"
  GH_TOKEN: ${{ secrets.GitHub_TOKEN }}

jobs:
  ares-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
      actions: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Env & Paths
      run: |
        mkdir -p output/{recon,probe,crawl,vulns,sql,xss,ssrf,lfi,redirect,crlf,cmdi,ssti,takeover,secrets,ports}
        echo "SCAN_TOOLS=${{ github.event.inputs.scan_type }}" >> $GITHUB_ENV
        echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV
        echo "$HOME/go/bin" >> $GITHUB_PATH
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "$HOME/tools" >> $GITHUB_PATH
        mkdir -p $HOME/go/bin $HOME/tools $HOME/.local/bin

    - name: Restore Previous Artifacts
      run: |
        if [ -n "${{ github.event.inputs.previous_run_id }}" ]; then
          PREV_ID=${{ github.event.inputs.previous_run_id }}
          echo " Downloading artifacts from Run $PREV_ID..."
          gh run download $PREV_ID -D output_prev >/dev/null 2>&1 || true
          cp -r output_prev/* output/ 2>/dev/null || true
        fi

    - name: Install Base Dependencies (Silent)
      run: |
        echo " Installing System Dependencies..."
        sudo apt-get update >/dev/null 2>&1
        sudo apt-get install -y python3-pip zip curl wget git libpcap-dev nikto jq ruby-full >/dev/null 2>&1
        
        # --- DRIVE UPLOADER ---
        cat << 'PYEOF' > drive_upload.py
        import os, sys, traceback
        try:
            # print(f" Uploading {sys.argv[1]}...") # Silence this too
            from google.oauth2.credentials import Credentials
            from googleapiclient.discovery import build
            from googleapiclient.http import MediaFileUpload
            
            creds = Credentials(None, 
                refresh_token=os.environ.get("GOOGLE_REFRESH_TOKEN"), 
                token_uri="https://oauth2.googleapis.com/token", 
                client_id=os.environ.get("GOOGLE_CLIENT_ID"), 
                client_secret=os.environ.get("GOOGLE_CLIENT_SECRET"))
                
            service = build("drive","v3",credentials=creds)
            folder_name, file_path = sys.argv[2], sys.argv[1]
            parent = os.environ.get("GDRIVE_FOLDER_ID")
            if parent:
                q = f"name='{folder_name}' and '{parent}' in parents and mimeType='application/vnd.google-apps.folder'"
                res = service.files().list(q=q).execute().get("files",[])
                fid = res[0]["id"] if res else service.files().create(body={"name":folder_name,"parents":[parent],"mimeType":"application/vnd.google-apps.folder"}).execute()["id"]
                file = service.files().create(body={"name":os.path.basename(file_path),"parents":[fid]}, media_body=MediaFileUpload(file_path)).execute()
                print(f" Uploaded to Drive: {file.get('id')}")
        except Exception as e:
            print(f" UPLOAD WARNING: {e}")
        PYEOF
        
        echo " Installing Python Libs..."
        pip3 install google-api-python-client google-auth-httplib2 google-auth-oauthlib >/dev/null 2>&1 || true

    - name: Install Selected Tools (Silent)
      run: |
        TOOLS="$SCAN_TOOLS"
        should_install() { [[ "$TOOLS" == "all" ]] || [[ ",$TOOLS," == *",$1,"* ]]; }
        export PATH=$PATH:$HOME/go/bin:$HOME/.local/bin
        
        echo " Installing Tools..."

        # GO TOOLS (Silent)
        if should_install "subfinder"; then go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest >/dev/null 2>&1; fi
        if should_install "assetfinder" || should_install "subfinder"; then go install -v github.com/tomnomnom/assetfinder@latest >/dev/null 2>&1; fi
        if should_install "httpx"; then go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest >/dev/null 2>&1; fi
        if should_install "naabu"; then go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest >/dev/null 2>&1; fi
        if should_install "nuclei"; then go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest >/dev/null 2>&1; fi
        if should_install "dalfox"; then go install -v github.com/hahwul/dalfox/v2@latest >/dev/null 2>&1; fi
        if should_install "ffuf"; then go install -v github.com/ffuf/ffuf/v2@latest >/dev/null 2>&1; fi
        if should_install "crlfuzz"; then go install -v github.com/dwisiswant0/crlfuzz/cmd/crlfuzz@latest >/dev/null 2>&1; fi
        if should_install "subzy"; then go install -v github.com/PentestPad/subzy@latest >/dev/null 2>&1; fi
        if should_install "gowitness"; then go install -v github.com/sensepost/gowitness@latest >/dev/null 2>&1; fi
        if should_install "amass"; then go install -v github.com/owasp-amass/amass/v4/...@latest >/dev/null 2>&1 || true; fi

        # PYTHON TOOLS (PIP - Silent)
        if should_install "arjun"; then pip3 install arjun -q; fi
        if should_install "commix"; then pip3 install commix -q; fi
        
        # PYTHON TOOLS (SOURCE - Silent)
        if should_install "paramspider"; then
           git clone https://github.com/devanshbatham/paramspider $HOME/tools/paramspider >/dev/null 2>&1 || true
           cd $HOME/tools/paramspider && pip3 install . -q || true
        fi
        
        if should_install "sqlmap"; then git clone https://github.com/sqlmapproject/sqlmap $HOME/tools/sqlmap >/dev/null 2>&1 || true; fi
        
        if should_install "ghauri"; then
           git clone https://github.com/r0oth3x49/ghauri $HOME/tools/ghauri >/dev/null 2>&1 || true
           cd $HOME/tools/ghauri && pip3 install . -q || true
        fi
        
        if should_install "ssrfmap"; then
           git clone https://github.com/swisskyrepo/SSRFmap $HOME/tools/ssrfmap >/dev/null 2>&1 || true
           cd $HOME/tools/ssrfmap && pip3 install -r requirements.txt -q || true
        fi
        
        if should_install "lfimap"; then
           git clone https://github.com/hansmach1ne/lfimap $HOME/tools/lfimap >/dev/null 2>&1 || true
           cd $HOME/tools/lfimap && pip3 install -r requirements.txt -q || true
        fi
        
        if should_install "openredirex"; then git clone https://github.com/devanshbatham/OpenRedireX $HOME/tools/openredirex >/dev/null 2>&1 || true; fi
        
        if should_install "tplmap"; then
           git clone https://github.com/epinna/tplmap $HOME/tools/tplmap >/dev/null 2>&1 || true
           cd $HOME/tools/tplmap && pip3 install -r requirements.txt -q || true
        fi
        
        if should_install "xsstrike"; then
           git clone https://github.com/s0md3v/XSStrike $HOME/tools/xsstrike >/dev/null 2>&1 || true
           cd $HOME/tools/xsstrike && pip3 install -r requirements.txt -q || true
        fi
        
        if should_install "feroxbuster"; then
           curl -sL https://raw.githubusercontent.com/epi052/feroxbuster/master/install-nix.sh | bash >/dev/null 2>&1 && sudo mv feroxbuster /usr/local/bin/ || true
        fi
        
        if should_install "gitleaks"; then
           curl -sL https://github.com/zricethezav/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz | tar xz >/dev/null 2>&1 && sudo mv gitleaks /usr/local/bin/ || true
        fi
        
        if should_install "feroxbuster" || should_install "ffuf"; then
            sudo mkdir -p /usr/share/wordlists
            wget -q https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt -O /usr/share/wordlists/common.txt
        fi
        echo " Tools Installed"

    - name: Execute ARES
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        TOOLS="$SCAN_TOOLS"
        echo "$TARGET" | tr ',' '\n' > targets.txt
        tg() { [ -n "$TELEGRAM_TOKEN" ] && curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" -d chat_id="$TELEGRAM_CHAT_ID" -d parse_mode="Markdown" -d text="$1" >/dev/null 2>&1 || true; }
        tg " *Run Started*\nTools: \`$TOOLS\`\nTargets: \`$TARGET\`"
        
        should_run() { [[ "$TOOLS" == "all" ]] || [[ ",$TOOLS," == *",$1,"* ]]; }
        export PATH=$PATH:$HOME/go/bin:$HOME/.local/bin

        # --- RECON ---
        if should_run "subfinder"; then
           echo " Running Subfinder..."
           subfinder -dL targets.txt -all -silent -o output/recon/subfinder.txt
           cat targets.txt | while read d; do assetfinder --subs-only $d >> output/recon/subs.txt; done
           cat output/recon/*.txt 2>/dev/null | sort -u > output/recon/all_subs.txt
           tg " Subfinder: $(wc -l < output/recon/all_subs.txt) subs"
        fi
        if should_run "amass"; then
           echo " Running Amass..."
           cat targets.txt | while read d; do timeout 1800 amass enum -passive -d $d -o output/recon/amass_${d}.txt >/dev/null 2>&1 || true; done
           tg " Amass Finished"
        fi

        # --- PROBE ---
        if should_run "httpx"; then
           echo " Running HTTPX..."
           LIST=targets.txt
           [ -s output/recon/all_subs.txt ] && LIST=output/recon/all_subs.txt
           httpx -l $LIST -ports 80,443 -threads 50 -title -silent -o output/probe/httpx.txt
           cat output/probe/httpx.txt | cut -d" " -f1 > output/probe/live.txt
           tg " HTTPX: $(wc -l < output/probe/live.txt) hosts"
        fi
        if should_run "naabu"; then
           echo " Running Naabu..."
           LIST=targets.txt
           [ -s output/recon/all_subs.txt ] && LIST=output/recon/all_subs.txt
           naabu -l $LIST -top-ports 100 -silent -o output/ports/naabu.txt
           tg " Naabu Finished"
        fi

        # --- CRAWL ---
        if should_run "paramspider"; then
           echo " Running ParamSpider..."
           LIST=targets.txt
           [ -s output/probe/live.txt ] && LIST=output/probe/live.txt
           cat $GITHUB_WORKSPACE/$LIST | while read d; do
              d=$(echo "$d" | sed 's|https://||;s|http://||')
              # FIX: Use binary
              paramspider -d $d --level high --output output/crawl/params_${d//\//_}.txt >/dev/null 2>&1 || true
              cat output/crawl/params_${d//\//_}.txt >> output/crawl/params.txt 2>/dev/null || true
           done
           grep "=" output/crawl/params.txt > output/crawl/param_urls.txt 2>/dev/null || true
           tg " ParamSpider: $(wc -l < output/crawl/param_urls.txt) urls"
        fi
        if should_run "arjun"; then
           echo " Running Arjun..."
           LIST=targets.txt
           [ -s output/probe/live.txt ] && LIST=output/probe/live.txt
           head -20 $LIST | while read u; do arjun -u "$u" -oT output/crawl/arjun.txt >/dev/null 2>&1 || true; done
           tg " Arjun Finished"
        fi

        # --- VULN ---
        if should_run "nuclei"; then
           echo " Running Nuclei..."
           nuclei -update-templates -silent >/dev/null 2>&1 || true
           LIST=targets.txt
           [ -s output/probe/live.txt ] && LIST=output/probe/live.txt
           nuclei -l $LIST -severity low,medium,high,critical -silent -o output/vulns/nuclei.txt
           tg " Nuclei Finished"
        fi
        if should_run "nikto"; then
           echo " Running Nikto..."
           cat targets.txt | while read u; do timeout 300 nikto -h "$u" -Tuning 123bde >/dev/null 2>&1 || true; done
           tg " Nikto Finished"
        fi
        if should_run "ffuf"; then
           echo " Running FFUF..."
           cat targets.txt | while read u; do ffuf -u "$u/FUZZ" -w /usr/share/wordlists/common.txt -mc 200 -s -o output/vulns/ffuf.json || true; done
           tg " FFUF Finished"
        fi
        if should_run "feroxbuster"; then
           echo " Running Feroxbuster..."
           cat targets.txt | while read u; do timeout 600 feroxbuster -u "$u" -w /usr/share/wordlists/common.txt --no-state --silent || true; done
           tg " Feroxbuster Finished"
        fi

        # --- ATTACK ---
        if should_run "dalfox"; then
           echo " Running Dalfox..."
           if [ -s output/crawl/param_urls.txt ]; then dalfox file output/crawl/param_urls.txt --silence -o output/xss/dalfox.txt; 
           else cat targets.txt | dalfox pipe --silence -o output/xss/dalfox.txt; fi
           tg " Dalfox Finished"
        fi
        if should_run "xsstrike"; then
           echo " Running XSStrike..."
           cd $HOME/tools/xsstrike
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           head -10 $LIST | while read u; do timeout 120 python3 xsstrike.py -u "$u" --crawl -l 2 >> $GITHUB_WORKSPACE/output/xss/xsstrike.txt 2>/dev/null || true; done
           cd $GITHUB_WORKSPACE
           tg " XSStrike Finished"
        fi
        if should_run "sqlmap"; then
           echo " Running SQLMap..."
           [ -s output/crawl/param_urls.txt ] && LIST=output/crawl/param_urls.txt || LIST=targets.txt
           head -20 $LIST | while read u; do
              if [[ "$u" == *"?"* ]]; then timeout 300 python3 $HOME/tools/sqlmap/sqlmap.py -u "$u" --batch --risk 2 --level 2 >> output/sql/sqlmap.txt 2>/dev/null || true; fi
           done
           tg " SQLMap Finished"
        fi
        if should_run "ghauri"; then
           echo " Running Ghauri..."
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           # FIX: Use binary
           head -10 $LIST | while read u; do timeout 120 ghauri -u "$u" --batch >> $GITHUB_WORKSPACE/output/sql/ghauri.txt 2>/dev/null || true; done
           tg " Ghauri Finished"
        fi
        if should_run "ssrfmap"; then 
           echo " Running SSRFMap..."
           cd $HOME/tools/ssrfmap
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           head -10 $LIST | while read u; do timeout 60 python3 ssrfmap.py -u "$u" -m readfiles >> $GITHUB_WORKSPACE/output/ssrf/ssrfmap.txt 2>/dev/null || true; done
           cd $GITHUB_WORKSPACE
           tg " SSRFMap Finished"
        fi
        if should_run "lfimap"; then
           echo " Running LFIMap..."
           cd $HOME/tools/lfimap
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           head -20 $LIST | while read u; do timeout 120 python3 lfimap.py -U "$u" >> $GITHUB_WORKSPACE/output/lfi/lfimap.txt 2>/dev/null || true; done
           cd $GITHUB_WORKSPACE
           tg " LFImap Finished"
        fi
        if should_run "openredirex"; then
           if [ -s output/crawl/param_urls.txt ]; then cat output/crawl/param_urls.txt | python3 $HOME/tools/openredirex/openredirex.py -p "http://evil.com" > output/redirect/openredirex.txt 2>/dev/null || true; fi
           tg " OpenRedireX Finished"
        fi
        if should_run "crlfuzz"; then cat targets.txt | crlfuzz -o output/crlf/crlfuzz.txt -silent || true; tg " CRLFuzz Finished"; fi
        if should_run "commix"; then
           echo " Running Commix..."
           [ -s output/crawl/param_urls.txt ] && LIST=output/crawl/param_urls.txt || LIST=targets.txt
           head -10 $LIST | while read u; do timeout 120 commix -u "$u" --batch >> output/cmdi/commix.txt 2>/dev/null || true; done
           tg " Commix Finished"
        fi
        if should_run "tplmap"; then
           echo " Running Tplmap..."
           cd $HOME/tools/tplmap
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           head -10 $LIST | while read u; do timeout 120 python3 tplmap.py -u "$u" >> $GITHUB_WORKSPACE/output/ssti/tplmap.txt 2>/dev/null || true; done
           cd $GITHUB_WORKSPACE
           tg " Tplmap Finished"
         fi
         if should_run "subzy"; then subzy run --targets targets.txt --hide_fails --output output/takeover/subzy.txt >/dev/null 2>&1 || true; tg " Subzy Finished"; fi
         if should_run "gitleaks"; then gitleaks detect --no-git -v > output/secrets/gitleaks.txt 2>/dev/null || true; tg " Gitleaks Finished"; fi

        # Upload Logic
        should_up() { [[ "$TOOLS" == "all" ]] || [[ ",$TOOLS," == *",$1,"* ]]; }
        
        if should_up "subfinder" || should_up "amass"; then DIRS="recon"; fi
        if should_up "httpx"; then DIRS="$DIRS probe"; fi
        if should_up "naabu"; then DIRS="$DIRS ports"; fi
        if should_up "paramspider" || should_up "arjun"; then DIRS="$DIRS crawl"; fi
        if should_up "nuclei" || should_up "nikto" || should_up "ffuf" || should_up "feroxbuster"; then DIRS="$DIRS vulns"; fi
        if should_up "dalfox" || should_up "xsstrike"; then DIRS="$DIRS xss"; fi
        if should_up "sqlmap" || should_up "ghauri"; then DIRS="$DIRS sql"; fi
        if should_up "ssrfmap"; then DIRS="$DIRS ssrf"; fi
        if should_up "lfimap"; then DIRS="$DIRS lfi"; fi
        if should_up "openredirex"; then DIRS="$DIRS redirect"; fi
        if should_up "crlfuzz"; then DIRS="$DIRS crlf"; fi
        if should_up "commix"; then DIRS="$DIRS cmdi"; fi
        if should_up "tplmap"; then DIRS="$DIRS ssti"; fi
        if should_up "subzy"; then DIRS="$DIRS takeover"; fi
        if should_up "gitleaks"; then DIRS="$DIRS secrets"; fi
        
        if [[ "$TOOLS" == "all" ]]; then DIRS="recon probe crawl vulns sql xss ssrf lfi redirect crlf cmdi ssti takeover secrets ports"; fi

        for dir in $DIRS; do
          if [ -d "output/$dir" ] && [ "$(ls -A output/$dir)" ]; then 
             zip -r "${dir}.zip" "output/$dir" >/dev/null || true
             python3 drive_upload.py "${dir}.zip" "ARES_${dir}"
          fi
        done

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: results-${{ env.SCAN_TOOLS }}-${{ github.run_id }}
        path: output/
        retention-days: 90