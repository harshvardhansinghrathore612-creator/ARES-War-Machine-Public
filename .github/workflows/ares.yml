name: ARES â€“ Multi-Tool Vulnerability Scanner

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Comma-separated tools OR "all" for full scan'
        required: true
        default: 'all'
        type: string
      target:
        description: 'Comma-separated Targets (domains/URLs)'
        required: true
        type: string

env:
  GOPATH: /home/runner/go
  GO111MODULE: "on"

jobs:
  ares-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 720

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup
      run: |
        mkdir -p output/{recon,probe,crawl,vulns,sql,xss,ssrf,lfi,redirect,crlf,cmdi,ssti,takeover,secrets,ports}
        echo "SCAN_TOOLS=${{ github.event.inputs.scan_type }}" >> $GITHUB_ENV
        echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV

    - name: Install Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip zip curl wget git libpcap-dev nikto jq ruby-full
        echo "$HOME/go/bin" >> $GITHUB_PATH
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        mkdir -p $HOME/tools

    - name: Install Go Tools
      run: |
        export PATH=$PATH:$HOME/go/bin
        go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        go install -v github.com/tomnomnom/assetfinder@latest
        go install -v github.com/owasp-amass/amass/v4/...@latest 2>/dev/null || true
        go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
        go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
        go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
        go install -v github.com/hahwul/dalfox/v2@latest
        go install -v github.com/ffuf/ffuf/v2@latest
        go install -v github.com/tomnomnom/qsreplace@latest
        go install -v github.com/dwisiswant0/crlfuzz/cmd/crlfuzz@latest
        go install -v github.com/PentestPad/subzy@latest
        go install -v github.com/sensepost/gowitness@latest
        sudo cp $HOME/go/bin/* /usr/local/bin/ 2>/dev/null || true

    - name: Install Python Tools
      run: |
        pip3 install --upgrade pip
        pip3 install arjun commix
        git clone --depth 1 https://github.com/s0md3v/XSStrike.git $HOME/tools/xsstrike
        cd $HOME/tools/xsstrike && pip3 install -r requirements.txt 2>/dev/null || true
        git clone --depth 1 https://github.com/devanshbatham/paramspider.git $HOME/tools/paramspider
        cd $HOME/tools/paramspider && pip3 install . 2>/dev/null || true
        git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git $HOME/tools/sqlmap
        git clone --depth 1 https://github.com/r0oth3x49/ghauri.git $HOME/tools/ghauri
        cd $HOME/tools/ghauri && pip3 install -r requirements.txt 2>/dev/null || pip3 install -e . 2>/dev/null || true
        git clone --depth 1 https://github.com/swisskyrepo/SSRFmap.git $HOME/tools/ssrfmap
        cd $HOME/tools/ssrfmap && pip3 install -r requirements.txt 2>/dev/null || true
        git clone --depth 1 https://github.com/hansmach1ne/lfimap.git $HOME/tools/lfimap
        cd $HOME/tools/lfimap && pip3 install -r requirements.txt 2>/dev/null || true
        git clone --depth 1 https://github.com/devanshbatham/OpenRedireX.git $HOME/tools/openredirex
        git clone --depth 1 https://github.com/epinna/tplmap.git $HOME/tools/tplmap
        cd $HOME/tools/tplmap && pip3 install -r requirements.txt 2>/dev/null || true

    - name: Install Feroxbuster
      run: |
        FEROX_URL=$(curl -s https://api.github.com/repos/epi052/feroxbuster/releases/latest | jq -r '.assets[] | select(.name | contains("x86_64") and contains("linux")) | .browser_download_url' | head -1)
        [ -n "$FEROX_URL" ] && curl -sL "$FEROX_URL" -o ferox.zip && unzip -o ferox.zip 2>/dev/null && sudo mv feroxbuster /usr/local/bin/ 2>/dev/null || true
        rm -f ferox.zip

    - name: Install Gitleaks
      run: |
        GITLEAKS_URL=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.assets[] | select(.name | test("linux_x64.tar.gz$")) | .browser_download_url' | head -1)
        [ -n "$GITLEAKS_URL" ] && curl -sL "$GITLEAKS_URL" | tar xz && sudo mv gitleaks /usr/local/bin/ 2>/dev/null || true

    - name: Install SecLists
      run: |
        git clone --depth 1 https://github.com/danielmiessler/SecLists.git $HOME/SecLists
        sudo mkdir -p /usr/share/wordlists
        sudo ln -sf $HOME/SecLists/Discovery/Web-Content/common.txt /usr/share/wordlists/common.txt

    - name: Create Drive Uploader
      run: |
        cat << 'PYEOF' > drive_upload.py
        import os, sys
        try:
            from google.oauth2.credentials import Credentials
            from googleapiclient.discovery import build
            from googleapiclient.http import MediaFileUpload
            required = ["GOOGLE_REFRESH_TOKEN", "GOOGLE_CLIENT_ID", "GOOGLE_CLIENT_SECRET", "GDRIVE_FOLDER_ID"]
            if any(not os.environ.get(v) for v in required):
                print("SKIP: Drive credentials missing"); sys.exit(0)
            creds = Credentials(None, refresh_token=os.environ["GOOGLE_REFRESH_TOKEN"],
                token_uri="https://oauth2.googleapis.com/token",
                client_id=os.environ["GOOGLE_CLIENT_ID"],
                client_secret=os.environ["GOOGLE_CLIENT_SECRET"])
            service = build("drive","v3",credentials=creds)
            folder_name, file_path = sys.argv[2], sys.argv[1]
            q = f"name='{folder_name}' and '{os.environ['GDRIVE_FOLDER_ID']}' in parents and mimeType='application/vnd.google-apps.folder'"
            res = service.files().list(q=q).execute().get("files",[])
            fid = res[0]["id"] if res else service.files().create(
                body={"name":folder_name,"mimeType":"application/vnd.google-apps.folder",
                "parents":[os.environ["GDRIVE_FOLDER_ID"]]},fields="id").execute()["id"]
            service.files().create(body={"name":os.path.basename(file_path),"parents":[fid]},
                media_body=MediaFileUpload(file_path),fields="id").execute()
            print(f" Uploaded {file_path}")
        except Exception as e: print(f"Upload error: {e}")
        PYEOF
        pip3 install google-api-python-client google-auth-httplib2 google-auth-oauthlib

    - name: Run ARES Scanner
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        TOOLS="$SCAN_TOOLS"
        echo "$TARGET" | tr ',' '\n' > targets.txt
        # Helper for notifications
        tg() {
          [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ] && \
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" -d parse_mode="Markdown" -d text="$1" >/dev/null 2>&1 || true
        }

        tg " *ARES* scan started\n\n Tools: \`$TOOLS\`\n Targets: \`$TARGET\`"

        should_run() {
          [[ "$TOOLS" == "all" ]] && return 0
          [[ ",$TOOLS," == *",$1,"* ]] && return 0
          return 1
        }

        # 1. SUBFINDER
        if should_run "subfinder"; then
          echo ""; echo "===  SUBFINDER ==="
          subfinder -dL targets.txt -all -o output/recon/subfinder.txt 2>/dev/null || true
          cat targets.txt | while read d; do
            assetfinder --subs-only $d >> output/recon/subs.txt 2>/dev/null || true
          done
          cat output/recon/*.txt 2>/dev/null | sort -u > output/recon/all_subs.txt
          tg " Subfinder complete"
        fi

        # 2. AMASS
        if should_run "amass"; then
          echo ""; echo "===  AMASS ==="
          cat targets.txt | while read d; do
             timeout 1800 amass enum -passive -d $d -o output/recon/amass_${d}.txt 2>/dev/null || true
             cat output/recon/amass_${d}.txt >> output/recon/all_subs.txt 2>/dev/null || true
          done
          sort -u -o output/recon/all_subs.txt output/recon/all_subs.txt
          tg " Amass complete"
        fi

        # 3. HTTPX
        if should_run "httpx"; then
          echo ""; echo "===  HTTPX ==="
          LIST=targets.txt
          [ -s output/recon/all_subs.txt ] && LIST=output/recon/all_subs.txt
          httpx -l $LIST -ports 80,443,8080,8443 -threads 50 -timeout 10 -status-code -title -o output/probe/httpx.txt 2>/dev/null || true
          cat output/probe/httpx.txt | cut -d" " -f1 > output/probe/live.txt
          tg " HTTPX complete"
        fi

        # 4. NAABU
        if should_run "naabu"; then
          echo ""; echo "===  NAABU ==="
          LIST=targets.txt
          [ -s output/recon/all_subs.txt ] && LIST=output/recon/all_subs.txt
          naabu -l $LIST -p 80,443,8080,8443,8000,3000,9000 -c 50 -o output/ports/naabu.txt 2>/dev/null || true
          tg " Naabu complete"
        fi

        # 5. PARAMSPIDER
        if should_run "paramspider"; then
          echo ""; echo "===  PARAMSPIDER ==="
          cd $HOME/tools/paramspider
          cat $GITHUB_WORKSPACE/targets.txt | while read d; do
             python3 -m paramspider -d $d --level high --output $GITHUB_WORKSPACE/output/crawl/params_${d}.txt 2>/dev/null || true
             cat $GITHUB_WORKSPACE/output/crawl/params_${d}.txt >> $GITHUB_WORKSPACE/output/crawl/params.txt 2>/dev/null || true
          done
          cd $GITHUB_WORKSPACE
          grep -E "^http" output/crawl/params.txt 2>/dev/null | grep -E "\?" > output/crawl/param_urls.txt || true
          tg " ParamSpider complete"
        fi

        # 6. ARJUN
        if should_run "arjun"; then
          echo ""; echo "===  ARJUN ==="
          cat targets.txt | while read u; do
            [[ "$u" != http* ]] && u="https://$u"
            arjun -u "$u" -oT output/crawl/arjun.txt 2>/dev/null || true
          done
          tg " Arjun complete"
        fi

        # 7. NUCLEI
        if should_run "nuclei"; then
          echo ""; echo "===  NUCLEI ==="
          LIST=targets.txt
          [ -s output/probe/live.txt ] && LIST=output/probe/live.txt
          nuclei -l $LIST -severity low,medium,high,critical -c 50 -timeout 10 -o output/vulns/nuclei.txt 2>/dev/null || true
          tg " Nuclei complete"
        fi

        # 8. NIKTO
        if should_run "nikto"; then
          cat targets.txt | while read u; do
            [[ "$u" != http* ]] && u="https://$u"
            timeout 600 nikto -h "$u" -Tuning 123bde > output/vulns/nikto.txt 2>&1 || true
          done
          tg " Nikto complete"
        fi
        
        # 9. FFUF
        if should_run "ffuf"; then
          cat targets.txt | while read u; do
            [[ "$u" != http* ]] && u="https://$u"
            ffuf -u "$u/FUZZ" -w /usr/share/wordlists/common.txt -t 60 -mc 200,204,301,302,401,403 -o output/vulns/ffuf.json 2>/dev/null || true
          done
          tg " FFUF complete"
        fi

        # 10. FEROXBUSTER
        if should_run "feroxbuster"; then
          cat targets.txt | while read u; do
            [[ "$u" != http* ]] && u="https://$u"
            timeout 900 feroxbuster -u "$u" -w /usr/share/wordlists/common.txt -t 50 -d 3 -o output/vulns/feroxbuster.txt 2>/dev/null || true
          done
          tg " Feroxbuster complete"
        fi

        # 11. DALFOX
        if should_run "dalfox"; then
           if [ -s output/crawl/param_urls.txt ]; then
             dalfox file output/crawl/param_urls.txt --silence -o output/xss/dalfox.txt 2>/dev/null || true
           elif [ -s targets.txt ]; then
             cat targets.txt | dalfox pipe --silence -o output/xss/dalfox.txt 2>/dev/null || true
           fi
           tg " Dalfox complete"
        fi

        # 12. SPLIT/LOOP TOOLS (Sqlmap, Ghauri, LFImap, etc) - Logic: if param_urls exist, use them. Else use targets.
        
        run_tool_params() {
           TOOLname=$1; BIN=$2; ARGS=$3
           echo ""; echo "=== $TOOLname ==="
           if [ -s output/crawl/param_urls.txt ]; then
             head -20 output/crawl/param_urls.txt | while read u; do
               timeout 300 $BIN -u "$u" $ARGS 2>&1 || true
             done
           elif [ -s targets.txt ]; then
             cat targets.txt | while read u; do
               # Only if URL has ?, otherwise skip or scan
               if [[ "$u" == *"?"* ]]; then
                  timeout 300 $BIN -u "$u" $ARGS 2>&1 || true
               fi
             done
           fi
           tg " $TOOLname complete"
        }

        if should_run "sqlmap"; then
           run_tool_params "SQLMap" "python3 $HOME/tools/sqlmap/sqlmap.py" "--batch --risk 2 --level 2 >> output/sql/sqlmap.txt"
        fi

        if should_run "ghauri"; then
           cd $HOME/tools/ghauri
           run_tool_params "Ghauri" "python3 -m ghauri" "--batch >> $GITHUB_WORKSPACE/output/sql/ghauri.txt"
           cd $GITHUB_WORKSPACE
        fi

        if should_run "ssrfmap"; then
           # Handling ssrfmap input slightly different
           echo "Running SSRFmap..."
        fi
        
        if should_run "lfimap"; then
           cd $HOME/tools/lfimap
           # custom func because argument is -U
           if [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ]; then
             head -20 $GITHUB_WORKSPACE/output/crawl/param_urls.txt | while read u; do
               timeout 300 python3 lfimap.py -U "$u" >> $GITHUB_WORKSPACE/output/lfi/lfimap.txt 2>&1 || true
             done
           fi
           cd $GITHUB_WORKSPACE
           tg " LFImap complete"
        fi

        if should_run "subzy"; then
           subzy run --targets targets.txt --hide_fails --output output/takeover/subzy.txt 2>/dev/null || true
           tg " Subzy complete"
        fi
        
        if should_run "gitleaks"; then
           gitleaks detect --no-git -v > output/secrets/gitleaks.txt 2>&1 || true
           tg " Gitleaks complete"
        fi

        # Upload results
        echo ""; echo "===  UPLOADING RESULTS ==="
        for dir in recon probe crawl vulns sql xss ssrf lfi redirect crlf cmdi ssti takeover secrets ports; do
          if [ -d "output/$dir" ] && [ "$(ls -A output/$dir 2>/dev/null)" ]; then
            zip -r "${dir}.zip" "output/$dir/" 2>/dev/null
            python3 drive_upload.py "${dir}.zip" "ARES_${dir}" 2>/dev/null || true
          fi
        done

        tg " *ARES* scan complete on \`$TARGET\`"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ares-scan-results-${{ github.run_id }}
        path: output/
        retention-days: 30
      
    - name: Cleanup
      if: always()
      run: |
        rm -rf output/ *.zip drive_upload.py 2>/dev/null || true
        rm -rf $HOME/tools/ $HOME/SecLists/ 2>/dev/null || true