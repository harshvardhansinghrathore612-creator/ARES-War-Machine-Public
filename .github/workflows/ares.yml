name: ARES â€“ Multi-Tool Vulnerability Scanner

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Comma-separated tools OR "all"'
        required: true
        default: 'all'
        type: string
      target:
        description: 'Target(s)'
        required: true
        type: string
      previous_run_id:
        description: 'Chain Artifacts from Run ID'
        required: false
        type: string

env:
  GOPATH: /home/runner/go
  GO111MODULE: "on"
  GH_TOKEN: ${{ secrets.GitHub_TOKEN }}

jobs:
  ares-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 900 # Bump to 15 hours for Deep Scans
    permissions:
      contents: read
      actions: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Env & Paths
      run: |
        mkdir -p output/{recon,probe,crawl,vulns,sql,xss,ssrf,lfi,redirect,crlf,cmdi,ssti,takeover,secrets,ports}
        echo "SCAN_TOOLS=${{ github.event.inputs.scan_type }}" >> $GITHUB_ENV
        echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV
        echo "$HOME/go/bin" >> $GITHUB_PATH
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "$HOME/tools" >> $GITHUB_PATH
        mkdir -p $HOME/go/bin $HOME/tools $HOME/.local/bin

    - name: Restore Previous Artifacts
      if: ${{ github.event.inputs.previous_run_id != '' }}
      env:
        PREV_ID: ${{ github.event.inputs.previous_run_id }}
      run: |
        echo "Downloading run $PREV_ID..."
        gh run download $PREV_ID -n "ares-scan-results-$PREV_ID" -D output_prev 2>/dev/null || gh run download $PREV_ID -n "output" -D output_prev 2>/dev/null || true
        cp -r output_prev/* output/ 2>/dev/null || true

    - name: Install Base Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip zip curl wget git libpcap-dev nikto jq ruby-full
        
        # --- DRIVE UPLOADER (DEBUG MODE) ---
        cat << 'PYEOF' > drive_upload.py
        import os, sys, traceback
        try:
            print(f" Uploading {sys.argv[1]} to {sys.argv[2]}...")
            from google.oauth2.credentials import Credentials
            from googleapiclient.discovery import build
            from googleapiclient.http import MediaFileUpload
            
            creds = Credentials(None, 
                refresh_token=os.environ.get("GOOGLE_REFRESH_TOKEN"), 
                token_uri="https://oauth2.googleapis.com/token", 
                client_id=os.environ.get("GOOGLE_CLIENT_ID"), 
                client_secret=os.environ.get("GOOGLE_CLIENT_SECRET"))
                
            service = build("drive","v3",credentials=creds)
            folder_name, file_path = sys.argv[2], sys.argv[1]
            parent = os.environ.get("GDRIVE_FOLDER_ID")
            if not parent: raise Exception("GDRIVE_FOLDER_ID missing!")
            q = f"name='{folder_name}' and '{parent}' in parents and mimeType='application/vnd.google-apps.folder'"
            res = service.files().list(q=q).execute().get("files",[])
            fid = res[0]["id"] if res else service.files().create(body={"name":folder_name,"parents":[parent],"mimeType":"application/vnd.google-apps.folder"}).execute()["id"]
            file = service.files().create(body={"name":os.path.basename(file_path),"parents":[fid]}, media_body=MediaFileUpload(file_path)).execute()
            print(f" Uploaded! ID: {file.get('id')}")
        except Exception as e:
            print(f" UPLOAD FAILED: {e}")
            traceback.print_exc()
            sys.exit(1)
        PYEOF
        
        pip3 install google-api-python-client google-auth-httplib2 google-auth-oauthlib || true

    - name: Install Selected Tools
      run: |
        TOOLS="$SCAN_TOOLS"
        should_install() { [[ "$TOOLS" == "all" ]] || [[ ",$TOOLS," == *",$1,"* ]]; }
        export PATH=$PATH:$HOME/go/bin:$HOME/.local/bin

        if should_install "subfinder"; then go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest; fi
        if should_install "assetfinder" || should_install "subfinder"; then go install -v github.com/tomnomnom/assetfinder@latest; fi
        if should_install "httpx"; then go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest; fi
        if should_install "naabu"; then go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest; fi
        if should_install "nuclei"; then go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest; fi
        if should_install "dalfox"; then go install -v github.com/hahwul/dalfox/v2@latest; fi
        if should_install "ffuf"; then go install -v github.com/ffuf/ffuf/v2@latest; fi
        if should_install "crlfuzz"; then go install -v github.com/dwisiswant0/crlfuzz/cmd/crlfuzz@latest; fi
        if should_install "subzy"; then go install -v github.com/PentestPad/subzy@latest; fi
        if should_install "gowitness"; then go install -v github.com/sensepost/gowitness@latest; fi
        if should_install "amass"; then go install -v github.com/owasp-amass/amass/v4/...@latest || true; fi

        if should_install "arjun"; then pip3 install arjun; fi
        if should_install "commix"; then pip3 install commix; fi
        
        if should_install "paramspider"; then
           git clone https://github.com/devanshbatham/paramspider $HOME/tools/paramspider || true
           cd $HOME/tools/paramspider && pip3 install . || true
        fi
        
        if should_install "sqlmap"; then git clone https://github.com/sqlmapproject/sqlmap $HOME/tools/sqlmap || true; fi
        
        if should_install "ghauri"; then
           git clone https://github.com/r0oth3x49/ghauri $HOME/tools/ghauri || true
           cd $HOME/tools/ghauri && pip3 install -r requirements.txt || true
        fi
        
        if should_install "ssrfmap"; then
           git clone https://github.com/swisskyrepo/SSRFmap $HOME/tools/ssrfmap || true
           cd $HOME/tools/ssrfmap && pip3 install -r requirements.txt || true
        fi
        
        if should_install "lfimap"; then
           git clone https://github.com/hansmach1ne/lfimap $HOME/tools/lfimap || true
           cd $HOME/tools/lfimap && pip3 install -r requirements.txt || true
        fi
        
        if should_install "openredirex"; then git clone https://github.com/devanshbatham/OpenRedireX $HOME/tools/openredirex || true; fi
        
        if should_install "tplmap"; then
           git clone https://github.com/epinna/tplmap $HOME/tools/tplmap || true
           cd $HOME/tools/tplmap && pip3 install -r requirements.txt || true
        fi
        
        if should_install "xsstrike"; then
           git clone https://github.com/s0md3v/XSStrike $HOME/tools/xsstrike || true
           cd $HOME/tools/xsstrike && pip3 install -r requirements.txt || true
        fi
        
        if should_install "feroxbuster"; then
           curl -sL https://raw.githubusercontent.com/epi052/feroxbuster/master/install-nix.sh | bash && sudo mv feroxbuster /usr/local/bin/ || true
        fi
        
        if should_install "gitleaks"; then
           curl -sL https://github.com/zricethezav/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz | tar xz && sudo mv gitleaks /usr/local/bin/ || true
        fi
        
        if should_install "feroxbuster" || should_install "ffuf"; then
            sudo mkdir -p /usr/share/wordlists
            # Upgrade: Download bigger wordlist for Deep Scan
            wget -q https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/raft-medium-directories.txt -O /usr/share/wordlists/common.txt
        fi

    - name: Execute ARES
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        TOOLS="$SCAN_TOOLS"
        echo "$TARGET" | tr ',' '\n' > targets.txt
        tg() { [ -n "$TELEGRAM_TOKEN" ] && curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" -d chat_id="$TELEGRAM_CHAT_ID" -d parse_mode="Markdown" -d text="$1" || true; }
        tg " *Run Started (Deep Scan)*\nTools: \`$TOOLS\`\nTargets: \`$TARGET\`"
        
        should_run() { [[ "$TOOLS" == "all" ]] || [[ ",$TOOLS," == *",$1,"* ]]; }

        # 1. SUBFINDER (Deep: Default -all is already deep)
        if should_run "subfinder"; then
           echo "--- RUNNING SUBFINDER ---"
           subfinder -dL targets.txt -all -v -o output/recon/subfinder.txt
           cat targets.txt | while read d; do assetfinder --subs-only $d >> output/recon/subs.txt; done
           cat output/recon/*.txt 2>/dev/null | sort -u > output/recon/all_subs.txt
           tg " Subfinder: $(wc -l < output/recon/all_subs.txt) subs"
        fi
        
        # 2. AMASS (Deep: Increased timeout)
        if should_run "amass"; then
           echo "--- RUNNING AMASS ---"
           cat targets.txt | while read d; do timeout 3600 amass enum -passive -d $d -o output/recon/amass_${d}.txt || true; done
           tg " Amass Finished"
        fi

        # 3. HTTPX (Deep: More ports)
        if should_run "httpx"; then
           echo "--- RUNNING HTTPX ---"
           LIST=targets.txt
           [ -s output/recon/all_subs.txt ] && LIST=output/recon/all_subs.txt
           # Ports 80,443 + 8000,8080,8443,8888,9000,9090
           httpx -l $LIST -ports 80,443,8000,8080,8443,8888,9000,9090 -threads 100 -title -tech-detect -verbose -o output/probe/httpx.txt
           cat output/probe/httpx.txt | cut -d" " -f1 > output/probe/live.txt
           tg " HTTPX: $(wc -l < output/probe/live.txt) hosts"
        fi

        # 4. NAABU (Deep: Top 1000 ports)
        if should_run "naabu"; then
           echo "--- RUNNING NAABU ---"
           LIST=targets.txt
           [ -s output/recon/all_subs.txt ] && LIST=output/recon/all_subs.txt
           # Upgrade: -top-ports 1000
           naabu -l $LIST -top-ports 1000 -v -o output/ports/naabu.txt
           tg " Naabu Finished"
        fi

        # 5. PARAMSPIDER (Deep: High level default)
        if should_run "paramspider"; then
           echo "--- RUNNING PARAMSPIDER ---"
           LIST=targets.txt
           [ -s output/probe/live.txt ] && LIST=output/probe/live.txt
           cat $GITHUB_WORKSPACE/$LIST | while read d; do
              d=$(echo "$d" | sed 's|https://||;s|http://||')
              python3 -m paramspider -d $d --level high --output output/crawl/params_${d//\//_}.txt || true
              cat output/crawl/params_${d//\//_}.txt >> output/crawl/params.txt 2>/dev/null || true
           done
           grep "=" output/crawl/params.txt > output/crawl/param_urls.txt 2>/dev/null || true
           tg " ParamSpider: $(wc -l < output/crawl/param_urls.txt) urls"
        fi

        # 6. ARJUN (Deep: Defaults good)
        if should_run "arjun"; then
           echo "--- RUNNING ARJUN ---"
           LIST=targets.txt
           [ -s output/probe/live.txt ] && LIST=output/probe/live.txt
           head -50 $LIST | while read u; do arjun -u "$u" -oT output/crawl/arjun.txt || true; done
           tg " Arjun Finished"
        fi

        # 7. NUCLEI (Deep: Update Templates + Low severity too)
        if should_run "nuclei"; then
           echo "--- RUNNING NUCLEI ---"
           nuclei -update-templates >/dev/null 2>&1 || true
           LIST=targets.txt
           [ -s output/probe/live.txt ] && LIST=output/probe/live.txt
           nuclei -l $LIST -severity low,medium,high,critical -v -o output/vulns/nuclei.txt
           tg " Nuclei Finished"
        fi

        # 8. NIKTO (Deep: Long timeout)
        if should_run "nikto"; then
           echo "--- RUNNING NIKTO ---"
           cat targets.txt | while read u; do timeout 600 nikto -h "$u" -Tuning 123bde || true; done
           tg " Nikto Finished"
        fi

        # 9. FFUF (Deep: Recursion + Bigger Wordlist)
        if should_run "ffuf"; then
           echo "--- RUNNING FFUF ---"
           cat targets.txt | while read u; do ffuf -u "$u/FUZZ" -w /usr/share/wordlists/common.txt -recursion -recursion-depth 2 -mc 200 -o output/vulns/ffuf.json || true; done
           tg " FFUF Finished"
        fi

        # 10. FEROXBUSTER (Deep: Recursion default)
        if should_run "feroxbuster"; then
           echo "--- RUNNING FEROXBUSTER ---"
           cat targets.txt | while read u; do timeout 1200 feroxbuster -u "$u" -w /usr/share/wordlists/common.txt --no-state || true; done
           tg " Feroxbuster Finished"
        fi

        # 11. DALFOX (Deep: Pipe mode full)
        if should_run "dalfox"; then
           echo "--- RUNNING DALFOX ---"
           if [ -s output/crawl/param_urls.txt ]; then dalfox file output/crawl/param_urls.txt --silence -o output/xss/dalfox.txt; 
           else cat targets.txt | dalfox pipe --silence -o output/xss/dalfox.txt; fi
           tg " Dalfox Finished"
        fi

        # 12. XSSTRIKE (Deep: Crawl Level 3)
        if should_run "xsstrike"; then
           echo "--- RUNNING XSSTRIKE ---"
           cd $HOME/tools/xsstrike
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           # Upgrade: -l 3 (Level 3 crawl)
           head -20 $LIST | while read u; do timeout 300 python3 xsstrike.py -u "$u" --crawl -l 3 >> $GITHUB_WORKSPACE/output/xss/xsstrike.txt || true; done
           cd $GITHUB_WORKSPACE
           tg " XSStrike Finished"
        fi

        # 13. SQLMAP (Deep: Level 3 Risk 2)
        if should_run "sqlmap"; then
           echo "--- RUNNING SQLMAP ---"
           [ -s output/crawl/param_urls.txt ] && LIST=output/crawl/param_urls.txt || LIST=targets.txt
           head -50 $LIST | while read u; do
              if [[ "$u" == *"?"* ]]; then timeout 600 python3 $HOME/tools/sqlmap/sqlmap.py -u "$u" --batch --risk 2 --level 3 -v 3 >> output/sql/sqlmap.txt || true; fi
           done
           tg " SQLMap Finished"
        fi

        # 14. GHAURI
        if should_run "ghauri"; then
           echo "--- RUNNING GHAURI ---"
           cd $HOME/tools/ghauri
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           head -20 $LIST | while read u; do timeout 300 python3 -m ghauri -u "$u" --batch --level 3 -v >> $GITHUB_WORKSPACE/output/sql/ghauri.txt || true; done
           cd $GITHUB_WORKSPACE
           tg " Ghauri Finished"
        fi

        # 15. SSRFMAP
        if should_run "ssrfmap"; then
           echo "--- RUNNING SSRFMAP ---"
           cd $HOME/tools/ssrfmap
           tg " SSRFMap Finished"
        fi

        # 16. LFIMAP
        if should_run "lfimap"; then
           echo "--- RUNNING LFIMAP ---"
           cd $HOME/tools/lfimap
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           head -20 $LIST | while read u; do timeout 300 python3 lfimap.py -U "$u" -v >> $GITHUB_WORKSPACE/output/lfi/lfimap.txt || true; done
           cd $GITHUB_WORKSPACE
           tg " LFImap Finished"
        fi

        # 17. OPENREDIREX
        if should_run "openredirex"; then
           echo "--- RUNNING OPENREDIREX ---"
           if [ -s output/crawl/param_urls.txt ]; then cat output/crawl/param_urls.txt | python3 $HOME/tools/openredirex/openredirex.py -p "http://evil.com" > output/redirect/openredirex.txt || true; fi
           tg " OpenRedireX Finished"
        fi

        # 18. CRLFUZZ
        if should_run "crlfuzz"; then
           echo "--- RUNNING CRLFUZZ ---"
           cat targets.txt | crlfuzz -o output/crlf/crlfuzz.txt || true
           tg " CRLFuzz Finished"
        fi

        # 19. COMMIX
        if should_run "commix"; then
           echo "--- RUNNING COMMIX ---"
           [ -s output/crawl/param_urls.txt ] && LIST=output/crawl/param_urls.txt || LIST=targets.txt
           head -20 $LIST | while read u; do timeout 300 commix -u "$u" --batch >> output/cmdi/commix.txt || true; done
           tg " Commix Finished"
        fi
        
        # 20. TPLMAP
        if should_run "tplmap"; then
           echo "--- RUNNING TPLMAP ---"
           cd $HOME/tools/tplmap
           [ -s $GITHUB_WORKSPACE/output/crawl/param_urls.txt ] && LIST=$GITHUB_WORKSPACE/output/crawl/param_urls.txt || LIST=$GITHUB_WORKSPACE/targets.txt
           head -20 $LIST | while read u; do timeout 300 python3 tplmap.py -u "$u" >> $GITHUB_WORKSPACE/output/ssti/tplmap.txt || true; done
           cd $GITHUB_WORKSPACE
           tg " Tplmap Finished"
         fi

         # 21. SUBZY
         if should_run "subzy"; then
            echo "--- RUNNING SUBZY ---"
            subzy run --targets targets.txt --hide_fails --output output/takeover/subzy.txt || true
            tg " Subzy Finished"
         fi

         # 22. GITLEAKS
         if should_run "gitleaks"; then
            echo "--- RUNNING GITLEAKS ---"
            gitleaks detect --no-git -v > output/secrets/gitleaks.txt || true
            tg " Gitleaks Finished"
         fi

        # Upload
        for dir in recon probe crawl vulns sql xss ssrf lfi redirect crlf cmdi ssti takeover secrets ports; do
          if [ -d "output/$dir" ] && [ "$(ls -A output/$dir)" ]; then 
             echo " Compressing $dir..."
             zip -r "${dir}.zip" "output/$dir" >/dev/null || true
             echo " Uploading ${dir}.zip to Drive..."
             python3 drive_upload.py "${dir}.zip" "ARES_${dir}"
             echo " ${dir}.zip Uploaded!"
          fi
        done

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ares-scan-results-${{ github.run_id }}
        path: output/
        retention-days: 90