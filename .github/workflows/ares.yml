name: ARES ‚Äì GitHub Safe Vulnerability Pipeline

on:
  workflow_dispatch:

jobs:
  security-hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Clean previous data
      run: |
        rm -rf output *.zip || true

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip zip curl git jq dnsutils
        mkdir -p output/{recon,probe,crawl,params,vulns,secrets,cloud,visual}
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    # ---------------- GO TOOLS ----------------
    - name: Install Go tools
      run: |
        go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        go install github.com/tomnomnom/assetfinder@latest
        go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
        go install github.com/projectdiscovery/httpx/cmd/httpx@latest
        go install github.com/tomnomnom/httprobe@latest
        go install github.com/projectdiscovery/katana/cmd/katana@latest
        go install github.com/lc/gau/v2/cmd/gau@latest
        go install github.com/tomnomnom/waybackurls@latest
        go install github.com/hakluke/hakrawler@latest
        go install github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
        go install github.com/hahwul/dalfox/v2@latest
        go install github.com/projectdiscovery/trufflehog/v3@latest
        go install github.com/gitleaks/gitleaks/v8@latest
        go install github.com/tomnomnom/unfurl@latest
        go install github.com/tomnomnom/qsreplace@latest
        go install github.com/Emoe/kxss@latest
        go install github.com/sensepost/gowitness@latest

    # ---------------- PYTHON TOOLS ----------------
    - name: Install Python tools
      run: |
        pip3 install paramspider arjun detect-secrets secretfinder corsy crlfsuite openredirex lfimap ssrfmap checkov tfsec

    # ---------------- GOOGLE DRIVE UPLOADER ----------------
    - name: Create Google Drive uploader
      run: |
        cat << 'EOF' > drive_upload.py
        import os,sys
        from google.oauth2.credentials import Credentials
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload

        creds = Credentials(
            None,
            refresh_token=os.environ["GOOGLE_REFRESH_TOKEN"],
            token_uri="https://oauth2.googleapis.com/token",
            client_id=os.environ["GOOGLE_CLIENT_ID"],
            client_secret=os.environ["GOOGLE_CLIENT_SECRET"]
        )

        service = build("drive","v3",credentials=creds)
        file_path=sys.argv[1]
        folder=sys.argv[2]

        res=service.files().list(q=f"name='{folder}' and '{os.environ['GDRIVE_FOLDER_ID']}' in parents").execute().get("files",[])
        fid=res[0]["id"] if res else service.files().create(
            body={"name":folder,"mimeType":"application/vnd.google-apps.folder","parents":[os.environ["GDRIVE_FOLDER_ID"]]},
            fields="id").execute()["id"]

        service.files().create(
            body={"name":os.path.basename(file_path),"parents":[fid]},
            media_body=MediaFileUpload(file_path)
        ).execute()
        EOF

    # ---------------- PIPELINE ----------------
    - name: Run ARES pipeline
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        TARGET=$(head -n 1 targets.txt)

        tg(){ curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" -d chat_id="$TELEGRAM_CHAT_ID" -d text="$1" >/dev/null; }

        tg "üöÄ ARES STARTED on $TARGET"

        # -------- RECON --------
        tg "üîç Recon started"
        subfinder -d $TARGET -silent > output/recon/subs.txt || true
        assetfinder --subs-only $TARGET >> output/recon/subs.txt || true
        sort -u output/recon/subs.txt > output/recon/final.txt
        zip -j recon.zip output/recon/*
        python3 drive_upload.py recon.zip Stage_1_Recon
        tg "‚úÖ Recon finished"

        # -------- PROBING --------
        tg "üåê Probing started"
        httpx -l output/recon/final.txt -silent > output/probe/live.txt || true
        httprobe < output/recon/final.txt >> output/probe/live.txt || true
        sort -u output/probe/live.txt -o output/probe/live.txt
        zip -j probe.zip output/probe/*
        python3 drive_upload.py probe.zip Stage_2_Probe
        tg "‚úÖ Probing finished"

        # -------- CRAWLING --------
        tg "üï∑ Crawling started"
        katana -l output/probe/live.txt -silent > output/crawl/katana.txt || true
        gau $TARGET > output/crawl/gau.txt || true
        waybackurls $TARGET > output/crawl/wayback.txt || true
        hakrawler -url https://$TARGET -plain > output/crawl/hakrawler.txt || true
        zip -j crawl.zip output/crawl/*
        python3 drive_upload.py crawl.zip Stage_3_Crawl
        tg "‚úÖ Crawling finished"

        # -------- PARAMS --------
        tg "üß™ Parameter discovery started"
        paramspider -d $TARGET --quiet -o output/params/paramspider.txt || true
        arjun -i output/probe/live.txt -o output/params/arjun.txt || true
        zip -j params.zip output/params/*
        python3 drive_upload.py params.zip Stage_4_Params
        tg "‚úÖ Parameter discovery finished"

        # -------- VULNERABILITIES --------
        tg "üí• Vulnerability scan started"
        nuclei -l output/probe/live.txt -severity high,critical -o output/vulns/nuclei.txt || true
        dalfox file output/crawl/katana.txt --skip-bav -o output/vulns/dalfox.txt || true
        corsy -i output/probe/live.txt > output/vulns/cors.txt || true
        zip -j vulns.zip output/vulns/*
        python3 drive_upload.py vulns.zip Stage_5_Vulns
        tg "‚úÖ Vulnerability scan finished"

        # -------- SECRETS --------
        tg "üîë Secrets scan started"
        trufflehog filesystem . > output/secrets/trufflehog.txt || true
        gitleaks detect --no-git -v > output/secrets/gitleaks.txt || true
        detect-secrets scan > output/secrets/detect-secrets.json || true
        zip -j secrets.zip output/secrets/*
        python3 drive_upload.py secrets.zip Stage_6_Secrets
        tg "üèÅ ARES COMPLETED on $TARGET"
