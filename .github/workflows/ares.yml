name: ARES - Multi-Tool Vulnerability Scanner

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Comma-separated tools OR "all" for full scan'
        required: true
        default: 'all'
        type: string
      target:
        description: 'Target domain or URL'
        required: true
        type: string
      previous_run_id:
        description: 'Previous Run ID for chaining'
        required: false
        type: string

env:
  GOPATH: /home/runner/go
  GO111MODULE: "on"

jobs:
  ares-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup
      run: |
        mkdir -p output/{recon,probe,crawl,vulns,sql,xss,ssrf,lfi,redirect,crlf,cmdi,ssti,takeover,secrets,ports}
        echo "SCAN_TOOLS=${{ github.event.inputs.scan_type }}" >> $GITHUB_ENV
        echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV

    - name: Install Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip zip curl wget git libpcap-dev nikto jq ruby-full
        echo "$HOME/go/bin" >> $GITHUB_PATH
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        mkdir -p $HOME/tools

    - name: Install Go Tools
      run: |
        export PATH=$PATH:$HOME/go/bin
        
        # Recon
        go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        go install -v github.com/tomnomnom/assetfinder@latest
        go install -v github.com/owasp-amass/amass/v4/...@latest 2>/dev/null || true
        
        # Probing
        go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
        go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
        
        # Vulnerability Scanning
        go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
        go install -v github.com/hahwul/dalfox/v2@latest
        go install -v github.com/ffuf/ffuf/v2@latest
        go install -v github.com/tomnomnom/qsreplace@latest
        
        # Specialized
        go install -v github.com/dwisiswant0/crlfuzz/cmd/crlfuzz@latest
        go install -v github.com/PentestPad/subzy@latest
        go install -v github.com/sensepost/gowitness@latest
        
        sudo cp $HOME/go/bin/* /usr/local/bin/ 2>/dev/null || true

    - name: Install Python Tools
      run: |
        pip3 install --upgrade pip
        pip3 install arjun commix
        
        # XSStrike (powerful XSS scanner)
        git clone --depth 1 https://github.com/s0md3v/XSStrike.git $HOME/tools/xsstrike
        cd $HOME/tools/xsstrike && pip3 install -r requirements.txt 2>/dev/null || true
        
        # ParamSpider
        git clone --depth 1 https://github.com/devanshbatham/paramspider.git $HOME/tools/paramspider
        cd $HOME/tools/paramspider && pip3 install . 2>/dev/null || true
        
        # SQLMap
        git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git $HOME/tools/sqlmap
        
        # Ghauri (advanced SQLi)
        git clone --depth 1 https://github.com/r0oth3x49/ghauri.git $HOME/tools/ghauri
        cd $HOME/tools/ghauri && pip3 install -r requirements.txt 2>/dev/null || pip3 install -e . 2>/dev/null || true
        
        # SSRFmap
        git clone --depth 1 https://github.com/swisskyrepo/SSRFmap.git $HOME/tools/ssrfmap
        cd $HOME/tools/ssrfmap && pip3 install -r requirements.txt 2>/dev/null || true
        
        # LFImap
        git clone --depth 1 https://github.com/hansmach1ne/lfimap.git $HOME/tools/lfimap
        cd $HOME/tools/lfimap && pip3 install -r requirements.txt 2>/dev/null || true
        
        # OpenRedireX
        git clone --depth 1 https://github.com/devanshbatham/OpenRedireX.git $HOME/tools/openredirex
        
        # Tplmap (SSTI)
        git clone --depth 1 https://github.com/epinna/tplmap.git $HOME/tools/tplmap
        cd $HOME/tools/tplmap && pip3 install -r requirements.txt 2>/dev/null || true

    - name: Install Feroxbuster
      run: |
        FEROX_URL=$(curl -s https://api.github.com/repos/epi052/feroxbuster/releases/latest | jq -r '.assets[] | select(.name | contains("x86_64") and contains("linux")) | .browser_download_url' | head -1)
        [ -n "$FEROX_URL" ] && curl -sL "$FEROX_URL" -o ferox.zip && unzip -o ferox.zip 2>/dev/null && sudo mv feroxbuster /usr/local/bin/ 2>/dev/null || true
        rm -f ferox.zip

    - name: Install Gitleaks
      run: |
        GITLEAKS_URL=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.assets[] | select(.name | test("linux_x64.tar.gz$")) | .browser_download_url' | head -1)
        [ -n "$GITLEAKS_URL" ] && curl -sL "$GITLEAKS_URL" | tar xz && sudo mv gitleaks /usr/local/bin/ 2>/dev/null || true

    - name: Install SecLists
      run: |
        git clone --depth 1 https://github.com/danielmiessler/SecLists.git $HOME/SecLists
        sudo ln -sf $HOME/SecLists/Discovery/Web-Content/common.txt /usr/share/wordlists/common.txt

    - name: Create Drive Uploader
      run: |
        cat << 'PYEOF' > drive_upload.py
        import os, sys
        try:
            from google.oauth2.credentials import Credentials
            from googleapiclient.discovery import build
            from googleapiclient.http import MediaFileUpload
            required = ["GOOGLE_REFRESH_TOKEN", "GOOGLE_CLIENT_ID", "GOOGLE_CLIENT_SECRET", "GDRIVE_FOLDER_ID"]
            if any(not os.environ.get(v) for v in required):
                print("SKIP: Drive credentials missing"); sys.exit(0)
            creds = Credentials(None, refresh_token=os.environ["GOOGLE_REFRESH_TOKEN"],
                token_uri="https://oauth2.googleapis.com/token",
                client_id=os.environ["GOOGLE_CLIENT_ID"],
                client_secret=os.environ["GOOGLE_CLIENT_SECRET"])
            service = build("drive","v3",credentials=creds)

            tool_name = sys.argv[1] # e.g., "subfinder"
            
            # Create/get the parent folder for this tool's results
            q_tool_folder = f"name='ARES_{tool_name}' and '{os.environ['GDRIVE_FOLDER_ID']}' in parents and mimeType='application/vnd.google-apps.folder'"
            res_tool_folder = service.files().list(q=q_tool_folder).execute().get("files",[])
            if res_tool_folder:
                tool_id = res_tool_folder[0]["id"]
            else:
                tool_id = service.files().create(
                    body={"name":f"ARES_{tool_name}","mimeType":"application/vnd.google-apps.folder",
                    "parents":[os.environ["GDRIVE_FOLDER_ID"]]},fields="id").execute()["id"]

            # Files to upload
            tool_files = {
                "subfinder": ["output/recon/subfinder.txt", "output/recon/all_subs.txt"],
                "httpx": ["output/probe/httpx.txt", "output/probe/live.txt"],
                "paramspider": ["output/crawl/param_urls.txt"],
                "nuclei": ["output/vulns/nuclei.txt"],
                "sqlmap": ["output/sql/sqlmap.txt"],
                "dalfox": ["output/xss/dalfox.txt"],
                "naabu": ["output/ports/naabu.txt"],
                "nikto": ["output/vulns/nikto.txt"],
                "ffuf": ["output/vulns/ffuf.json"],
                "crlfuzz": ["output/crlf/crlfuzz.txt"],
                "subzy": ["output/takeover/subzy.txt"],
                "gitleaks": ["output/secrets/gitleaks.txt"],
                "amass": ["output/recon/amass.txt"],
                "arjun": ["output/crawl/arjun.txt"],
                "feroxbuster": ["output/vulns/feroxbuster.txt"],
                "xsstrike": ["output/xss/xsstrike.txt"],
                "ghauri": ["output/sql/ghauri.txt"],
                "ssrfmap": ["output/ssrf/ssrfmap.txt"],
                "lfimap": ["output/lfi/lfimap.txt"],
                "openredirex": ["output/redirect/openredirex.txt"],
                "commix": ["output/cmdi/commix.txt"],
                "tplmap": ["output/ssti/tplmap.txt"],
            }
            
            for filepath in tool_files.get(tool_name, []):
                if os.path.exists(filepath) and os.path.getsize(filepath) > 0:
                    filename = os.path.basename(filepath)
                    media = MediaFileUpload(filepath, resumable=True)
                    existing = service.files().list(q=f"name='{filename}' and '{tool_id}' in parents and trashed=false", fields="files(id)").execute().get("files", [])
                    if existing:
                        service.files().update(fileId=existing[0]["id"], media_body=media).execute()
                        print(f"Updated: {filename}")
                    else:
                        service.files().create(body={"name": filename, "parents": [tool_id]}, media_body=media).execute()
                        print(f"Uploaded: {filename}")
                else:
                    print(f"Skipping empty or non-existent file: {filepath}")
        except Exception as e: print(f"Upload error: {e}")
        PYEOF
        pip3 install google-api-python-client google-auth-httplib2 google-auth-oauthlib

    - name: Run ARES Scanner
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        TOOLS="$SCAN_TOOLS"
        DOMAIN=$(echo "$TARGET" | sed 's|https://||;s|http://||;s|/.*||')
        TGT="$TARGET" # Shorthand for target

        echo "=========================================="
        echo "---- ARES Scanner"
        echo "---- Tools: $TOOLS"
        echo "---- Target: $TARGET"
        echo "---- Domain: $DOMAIN"
        echo "=========================================="

        # Telegram notification
        tg() {
          [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ] && \
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" -d parse_mode="Markdown" -d text="$1" >/dev/null 2>&1 || true
        }

        tg "---- *ARES* scan started\n\n---- Tools: \`$TOOLS\`\n---- Target: \`$TARGET\`"

        # Check if tool should run
        should_run() {
          [[ "$TOOLS" == "all" ]] && return 0
          [[ ",$TOOLS," == *",$1,"* ]] && return 0
          return 1
        }

        # Function to upload results for a specific tool
        upload_tool_results() {
          local tool_name=$1
          echo "Uploading results for $tool_name..."
          python3 drive_upload.py "$tool_name" 2>/dev/null || true
        }

        ###########################################
        # SUBFINDER - Subdomain Enumeration
        ###########################################
        if should_run "subfinder"; then
          echo ""; echo "=== ---- SUBFINDER ==="
          subfinder -d $DOMAIN -all -o output/recon/subfinder.txt 2>&1 | tee output/recon/subfinder_log.txt || true
          assetfinder --subs-only $DOMAIN >> output/recon/subs.txt 2>&1 || true
          cat output/recon/*.txt 2>/dev/null | sort -u > output/recon/all_subs.txt
          echo "[+] Subdomains: $(wc -l < output/recon/all_subs.txt 2>/dev/null || echo 0)"
          tg "--- Subfinder: $(wc -l < output/recon/all_subs.txt 2>/dev/null || echo 0) subdomains"
          upload_tool_results "subfinder"
        fi

        ###########################################
        # AMASS - Deep Subdomain Discovery
        ###########################################
        if should_run "amass"; then
          echo ""; echo "=== ---- AMASS ==="
          timeout 1800 amass enum -passive -d $DOMAIN -o output/recon/amass.txt 2>&1 | tee output/recon/amass_log.txt || true
          cat output/recon/amass.txt >> output/recon/all_subs.txt 2>/dev/null || true
          sort -u -o output/recon/all_subs.txt output/recon/all_subs.txt
          tg "--- Amass complete"
          upload_tool_results "amass"
        fi

        ###########################################
        # HTTPX - Live Host Detection
        ###########################################
        if should_run "httpx"; then
          echo ""; echo "=== ---- HTTPX ==="
          [ ! -s output/recon/all_subs.txt ] && echo "$DOMAIN" > output/recon/all_subs.txt
          httpx -l output/recon/all_subs.txt -ports 80,443,8080,8443 -threads 50 -timeout 10 \
            -status-code -title -o output/probe/httpx.txt 2>&1 | tee output/probe/httpx_log.txt || true
          cat output/probe/httpx.txt | cut -d" " -f1 > output/probe/live.txt
          echo "[+] Live: $(wc -l < output/probe/live.txt 2>/dev/null || echo 0)"
          tg "--- HTTPX: $(wc -l < output/probe/live.txt 2>/dev/null || echo 0) live hosts"
          upload_tool_results "httpx"
        fi

        ###########################################
        # NAABU - Port Scanner
        ###########################################
        if should_run "naabu"; then
          echo ""; echo "=== ---- NAABU ==="
          [ ! -s output/recon/all_subs.txt ] && echo "$DOMAIN" > output/recon/all_subs.txt
          naabu -l output/recon/all_subs.txt -p 80,443,8080,8443,8000,3000,9000 -c 50 \
            -o output/ports/naabu.txt 2>&1 | tee output/ports/naabu_log.txt || true
          tg "--- Naabu: $(wc -l < output/ports/naabu.txt 2>/dev/null || echo 0) ports"
          upload_tool_results "naabu"
        fi

        ###########################################
        # PARAMSPIDER - Parameter Discovery
        ###########################################
        if should_run "paramspider"; then
          echo ""; echo "=== ------- PARAMSPIDER ==="
          cd $HOME/tools/paramspider
          python3 -m paramspider -d $DOMAIN --level high -o $GITHUB_WORKSPACE/output/crawl/params.txt 2>&1 | tee $GITHUB_WORKSPACE/output/crawl/paramspider_log.txt || true
          cd $GITHUB_WORKSPACE
          grep -E "^http" output/crawl/params.txt 2>/dev/null | grep -E "\?" > output/crawl/param_urls.txt || true
          echo "[+] Params: $(wc -l < output/crawl/param_urls.txt 2>/dev/null || echo 0)"
          tg "--- ParamSpider: $(wc -l < output/crawl/param_urls.txt 2>/dev/null || echo 0) URLs"
          upload_tool_results "paramspider"
        fi

        ###########################################
        # ARJUN - Hidden Parameter Discovery
        ###########################################
        if should_run "arjun"; then
          echo ""; echo "=== ---- ARJUN ==="
          URL="$TGT"; [[ "$URL" != http* ]] && URL="https://$TGT"
          arjun -u "$URL" -oT output/crawl/arjun.txt 2>&1 | tee output/crawl/arjun_log.txt || true
          tg "--- Arjun complete"
          upload_tool_results "arjun"
        fi

        ###########################################
        # NUCLEI - Template Scanner
        ###########################################
        if should_run "nuclei"; then
          echo ""; echo "=== ------ NUCLEI ==="
          if [ -s output/probe/live.txt ]; then INPUT="output/probe/live.txt"; else echo "https://$TGT" > targets.txt; INPUT="targets.txt"; fi
          echo "Nuclei Input: $INPUT"
          cat "$INPUT"
          echo "---"
          # UNLIMITED MODE + SEVERITY FILTER (As requested)
          nuclei -l "$INPUT" -severity low,medium,high,critical \
            -c 50 -timeout 10 -o output/vulns/nuclei.txt 2>&1 | tee output/vulns/nuclei_log.txt || true
          COUNT=$(wc -l < output/vulns/nuclei.txt 2>/dev/null || echo 0)
          echo "RESULT: $COUNT vulnerabilities"
          tg "--- Nuclei: $COUNT vulns"
          upload_tool_results "nuclei"
        fi

        ###########################################
        # NIKTO - Web Server Scanner
        ###########################################
        if should_run "nikto"; then
          echo ""; echo "=== ---- NIKTO ==="
          URL="$TGT"; [[ "$URL" != http* ]] && URL="https://$TGT"
          timeout 600 nikto -h "$URL" -Tuning 123bde -maxtime 300 > output/vulns/nikto.txt 2>&1 | tee output/vulns/nikto_log.txt || true
          tg "--- Nikto complete"
          upload_tool_results "nikto"
        fi

        ###########################################
        # FFUF - Directory Fuzzing
        ###########################################
        if should_run "ffuf"; then
          echo ""; echo "=== ---- FFUF ==="
          URL="$TGT"; [[ "$URL" != http* ]] && URL="https://$TGT"
          ffuf -u "$URL/FUZZ" -w /usr/share/wordlists/common.txt -t 100 -mc 200,204,301,302,401,403 \
            -o output/vulns/ffuf.json 2>&1 | tee output/vulns/ffuf_log.txt || true
          tg "--- FFUF complete"
          upload_tool_results "ffuf"
        fi

        ###########################################
        # FEROXBUSTER - Recursive Discovery
        ###########################################
        if should_run "feroxbuster"; then
          echo ""; echo "=== ---- FEROXBUSTER ==="
          URL="$TGT"; [[ "$URL" != http* ]] && URL="https://$TGT"
          timeout 900 feroxbuster -u "$URL" -w /usr/share/wordlists/common.txt -t 50 -d 3 \
            -o output/vulns/feroxbuster.txt 2>&1 | tee output/vulns/feroxbuster_log.txt || true
          tg "--- Feroxbuster complete"
          upload_tool_results "feroxbuster"
        fi

        ###########################################
        # DALFOX - XSS Scanner
        ###########################################
        if should_run "dalfox"; then
          echo ""; echo "=== ---- DALFOX (XSS) ==="
          if [ -s output/crawl/param_urls.txt ]; then
            dalfox file output/crawl/param_urls.txt --silence -o output/xss/dalfox.txt 2>&1 | tee output/xss/dalfox_log.txt || true
          elif [[ "$TGT" == *"?"* ]]; then
            echo "$TGT" | dalfox pipe --silence -o output/xss/dalfox.txt 2>&1 | tee output/xss/dalfox_log.txt || true
          else
            echo "[!] No param URLs for Dalfox"
          fi
          tg "--- Dalfox: $(wc -l < output/xss/dalfox.txt 2>/dev/null || echo 0) XSS"
          upload_tool_results "dalfox"
        fi

        ###########################################
        # XSSTRIKE - Advanced XSS
        ###########################################
        if should_run "xsstrike"; then
          echo ""; echo "=== --- XSSTRIKE ==="
          if [[ "$TGT" == *"?"* ]]; then
            cd $HOME/tools/xsstrike
            timeout 600 python3 xsstrike.py -u "$TGT" --crawl -l 2 > $GITHUB_WORKSPACE/output/xss/xsstrike.txt 2>&1 | tee $GITHUB_WORKSPACE/output/xss/xsstrike_log.txt || true
            cd $GITHUB_WORKSPACE
          elif [ -s output/crawl/param_urls.txt ]; then
            head -10 output/crawl/param_urls.txt | while read url; do
              cd $HOME/tools/xsstrike
              timeout 120 python3 xsstrike.py -u "$url" >> $GITHUB_WORKSPACE/output/xss/xsstrike.txt 2>&1 | tee -a $GITHUB_WORKSPACE/output/xss/xsstrike_log.txt || true
              cd $GITHUB_WORKSPACE
            done
          fi
          tg "--- XSStrike complete"
          upload_tool_results "xsstrike"
        fi

        ###########################################
        # SQLMAP - SQL Injection
        ###########################################
        if should_run "sqlmap"; then
          echo ""; echo "=== ---- SQLMAP ==="
          mkdir -p output/sql/sqlmap
          if [[ "$TGT" == *"?"* ]]; then
            timeout 900 python3 $HOME/tools/sqlmap/sqlmap.py -u "$TGT" --batch --risk 2 --level 3 \
              --threads 5 --output-dir=output/sql/sqlmap 2>&1 | tee output/sql/sqlmap_log.txt || true
            # SQLMap output is in output/sql/sqlmap, but we want a single file for upload
            find output/sql/sqlmap -type f -name "*.txt" -exec cat {} + > output/sql/sqlmap.txt || true
          elif [ -s output/crawl/param_urls.txt ]; then
            head -15 output/crawl/param_urls.txt | while read url; do
              timeout 180 python3 $HOME/tools/sqlmap/sqlmap.py -u "$url" --batch --risk 2 --level 2 \
                --threads 3 >> output/sql/sqlmap.txt 2>&1 | tee -a output/sql/sqlmap_log.txt || true
            done
          else
            echo "[!] SQLMap needs parameterized URLs"
          fi
          tg "--- SQLMap complete"
          upload_tool_results "sqlmap"
        fi

        ###########################################
        # GHAURI - Advanced SQLi
        ###########################################
        if should_run "ghauri"; then
          echo ""; echo "=== ---- GHAURI ==="
          if [[ "$TGT" == *"?"* ]]; then
            cd $HOME/tools/ghauri
            timeout 600 python3 -m ghauri -u "$TGT" --batch > $GITHUB_WORKSPACE/output/sql/ghauri.txt 2>&1 | tee $GITHUB_WORKSPACE/output/sql/ghauri_log.txt || true
            cd $GITHUB_WORKSPACE
          elif [ -s output/crawl/param_urls.txt ]; then
            head -10 output/crawl/param_urls.txt | while read url; do
              cd $HOME/tools/ghauri
              timeout 120 python3 -m ghauri -u "$url" --batch >> $GITHUB_WORKSPACE/output/sql/ghauri.txt 2>&1 | tee -a $GITHUB_WORKSPACE/output/sql/ghauri_log.txt || true
              cd $GITHUB_WORKSPACE
            done
          fi
          tg "--- Ghauri complete"
          upload_tool_results "ghauri"
        fi

        ###########################################
        # SSRFMAP - SSRF Scanner
        ###########################################
        if should_run "ssrfmap"; then
          echo ""; echo "=== ---- SSRFMAP ==="
          if [[ "$TARGET" == *"?"* ]]; then
            cd $HOME/tools/ssrfmap
            timeout 600 python3 ssrfmap.py -r <(echo -e "GET $TARGET HTTP/1.1\nHost: $(echo $TARGET | cut -d/ -f3)") \
              -p url > $GITHUB_WORKSPACE/output/ssrf/ssrfmap.txt 2>&1 || true
            cd $GITHUB_WORKSPACE
          fi
          tg "--- SSRFmap complete"
        fi

        ###########################################
        # LFIMAP - LFI Scanner
        ###########################################
        if should_run "lfimap"; then
          echo ""; echo "=== ---- LFIMAP ==="
          if [[ "$TARGET" == *"?"* ]]; then
            cd $HOME/tools/lfimap
            timeout 600 python3 lfimap.py -U "$TARGET" > $GITHUB_WORKSPACE/output/lfi/lfimap.txt 2>&1 || true
            cd $GITHUB_WORKSPACE
          elif [ -s output/crawl/param_urls.txt ]; then
            head -10 output/crawl/param_urls.txt | while read url; do
              cd $HOME/tools/lfimap
              timeout 120 python3 lfimap.py -U "$url" >> $GITHUB_WORKSPACE/output/lfi/lfimap.txt 2>&1 || true
              cd $GITHUB_WORKSPACE
            done
          fi
          tg "--- LFImap complete"
        fi

        ###########################################
        # OPENREDIREX - Open Redirect Scanner
        ###########################################
        if should_run "openredirex"; then
          echo ""; echo "=== ------ OPENREDIREX ==="
          if [ -s output/crawl/param_urls.txt ]; then
            cat output/crawl/param_urls.txt | python3 $HOME/tools/openredirex/openredirex.py -p "https://evil.com" \
              > output/redirect/openredirex.txt 2>/dev/null || true
          fi
          tg "--- OpenRedireX complete"
        fi

        ###########################################
        # CRLFUZZ - CRLF Injection
        ###########################################
        if should_run "crlfuzz"; then
          echo ""; echo "=== ------ CRLFUZZ ==="
          URL="$TARGET"; [[ "$URL" != http* ]] && URL="https://$TARGET"
          echo "$URL" | crlfuzz -o output/crlf/crlfuzz.txt 2>/dev/null || true
          tg "--- CRLFuzz: $(wc -l < output/crlf/crlfuzz.txt 2>/dev/null || echo 0) findings"
        fi

        ###########################################
        # COMMIX - Command Injection
        ###########################################
        if should_run "commix"; then
          echo ""; echo "=== ---- COMMIX ==="
          if [[ "$TARGET" == *"?"* ]]; then
            timeout 600 commix -u "$TARGET" --batch --all > output/cmdi/commix.txt 2>&1 || true
          elif [ -s output/crawl/param_urls.txt ]; then
            head -10 output/crawl/param_urls.txt | while read url; do
              timeout 120 commix -u "$url" --batch >> output/cmdi/commix.txt 2>&1 || true
            done
          fi
          tg "--- Commix complete"
        fi

        ###########################################
        # TPLMAP - SSTI Scanner
        ###########################################
        if should_run "tplmap"; then
          echo ""; echo "=== ---- TPLMAP (SSTI) ==="
          if [[ "$TARGET" == *"?"* ]]; then
            cd $HOME/tools/tplmap
            timeout 600 python3 tplmap.py -u "$TARGET" > $GITHUB_WORKSPACE/output/ssti/tplmap.txt 2>&1 || true
            cd $GITHUB_WORKSPACE
          elif [ -s output/crawl/param_urls.txt ]; then
            head -10 output/crawl/param_urls.txt | while read url; do
              cd $HOME/tools/tplmap
              timeout 120 python3 tplmap.py -u "$url" >> $GITHUB_WORKSPACE/output/ssti/tplmap.txt 2>&1 || true
              cd $GITHUB_WORKSPACE
            done
          fi
          tg "--- Tplmap complete"
        fi

        ###########################################
        # SUBZY - Subdomain Takeover
        ###########################################
        if should_run "subzy"; then
          echo ""; echo "=== ---- SUBZY ==="
          [ ! -s output/recon/all_subs.txt ] && echo "$DOMAIN" > output/recon/all_subs.txt
          subzy run --targets output/recon/all_subs.txt --hide_fails --output output/takeover/subzy.txt 2>/dev/null || true
          tg "--- Subzy complete"
        fi

        ###########################################
        # GITLEAKS - Secret Detection
        ###########################################
        if should_run "gitleaks"; then
          echo ""; echo "=== ---- GITLEAKS ==="
          gitleaks detect --no-git -v > output/secrets/gitleaks.txt 2>&1 || true
          tg "--- Gitleaks complete"
        fi

        # Upload results
        echo ""; echo "=== ---- UPLOADING RESULTS ==="
        for dir in recon probe crawl vulns sql xss ssrf lfi redirect crlf cmdi ssti takeover secrets ports; do
          if [ -d "output/$dir" ] && [ "$(ls -A output/$dir 2>/dev/null)" ]; then
            zip -r "${dir}.zip" "output/$dir/" 2>/dev/null
            python3 drive_upload.py "${dir}.zip" "ARES_${dir}" 2>/dev/null || true
          fi
        done

        echo ""
        echo "=========================================="
        echo "---- ARES Scan Complete!"
        echo "=========================================="
        tg "---- *ARES* scan complete on \`$TARGET\`"

    - name: Cleanup
      if: always()
      run: |
        rm -rf output/ *.zip drive_upload.py 2>/dev/null || true
        rm -rf $HOME/tools/ $HOME/SecLists/ 2>/dev/null || true


