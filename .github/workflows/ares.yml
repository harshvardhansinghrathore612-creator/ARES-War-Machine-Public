name: ARES ‚Äì GitHub Safe Vulnerability Pipeline
on:
  workflow_dispatch:
env:
  GOPATH: /home/runner/go
  GO111MODULE: "on"
jobs:
  security-hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
    - name: Clean previous data
      run: |
        rm -rf output *.zip || true
        mkdir -p output/{recon,probe,crawl,vulns,secrets,specialized,graphql,api,cloud,sql,nosql,xxe,auth,templates,deserialization}
    - name: Install Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    - name: Install core dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip python3-venv zip curl wget git ruby-full libpcap-dev libxml2-dev libxslt1-dev libsqlite3-dev libffi-dev npm build-essential
        # Set up proper PATH for Go binaries
        echo "GOPATH=$HOME/go" >> $GITHUB_ENV
        echo "$HOME/go/bin" >> $GITHUB_PATH
        echo "/usr/local/go/bin" >> $GITHUB_PATH
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        # Create tools directory
        mkdir -p $HOME/tools
    - name: Install Rust (for x8)
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    - name: Install massdns (required for puredns)
      run: |
        echo "Installing massdns..."
        git clone --depth 1 https://github.com/blechschmidt/massdns.git $HOME/tools/massdns
        cd $HOME/tools/massdns
        make
        sudo cp bin/massdns /usr/local/bin/
        massdns --help || echo "massdns installed"
    - name: Install SecLists from GitHub
      run: |
        echo "Installing SecLists from GitHub..."
        git clone --depth 1 https://github.com/danielmiessler/SecLists.git $HOME/SecLists
        sudo mkdir -p /usr/share/wordlists/
        sudo ln -sf $HOME/SecLists/Discovery/Web-Content/common.txt /usr/share/wordlists/common.txt 2>/dev/null || true
        sudo ln -sf $HOME/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt /usr/share/wordlists/dirb-medium.txt 2>/dev/null || true
    - name: Install Go tools
      run: |
        echo "Installing Go tools..."
        export PATH=$PATH:$HOME/go/bin:/usr/local/go/bin
        
        go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        go install github.com/tomnomnom/assetfinder@latest
        go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
        go install github.com/projectdiscovery/httpx/cmd/httpx@latest
        go install github.com/projectdiscovery/katana/cmd/katana@latest
        go install github.com/lc/gau/v2/cmd/gau@latest
        go install github.com/hahwul/dalfox/v2@latest
        go install github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
        go install github.com/tomnomnom/waybackurls@latest
        go install github.com/hakluke/hakrawler@latest
        go install github.com/tomnomnom/qsreplace@latest
        go install github.com/tomnomnom/unfurl@latest
        go install github.com/Emoe/kxss@latest
        go install github.com/aquasecurity/tfsec/cmd/tfsec@latest
        go install github.com/projectdiscovery/chaos-client/cmd/chaos@latest
        go install github.com/d3mondev/puredns/v2@latest
        go install github.com/sensepost/gowitness@latest
        go install github.com/ffuf/ffuf/v2@latest
        go install github.com/projectdiscovery/interactsh/cmd/interactsh-client@latest
        go install github.com/jaeles-project/gospider@latest
        
        sudo cp $HOME/go/bin/* /usr/local/bin/ 2>/dev/null || true
    - name: Install Python tools (PyPI verified)
      run: |
        echo "Installing Python tools from PyPI..."
        pip3 install --upgrade pip --user
        # Note: x8 is NOT a Python package, it's Rust - removed from here
        pip3 install arjun checkov s3scanner swagger-parser commix --user || true
    - name: Install x8 (Rust - from GitHub)
      run: |
        echo "Installing x8 from GitHub..."
        source $HOME/.cargo/env
        cargo install x8 || {
          echo "cargo install failed, trying from source..."
          git clone --depth 1 https://github.com/Sh1Yo/x8.git $HOME/tools/x8
          cd $HOME/tools/x8
          cargo build --release
          sudo cp target/release/x8 /usr/local/bin/
        }
    - name: Install git-secrets (AWS tool)
      run: |
        echo "Installing git-secrets from AWS..."
        git clone --depth 1 https://github.com/awslabs/git-secrets.git $HOME/tools/git-secrets
        cd $HOME/tools/git-secrets
        sudo make install
        which git-secrets || echo "git-secrets installed via make"
    - name: Install paramspider (from GitHub - FIXED)
      run: |
        echo "Installing paramspider from GitHub..."
        git clone --depth 1 https://github.com/devanshbatham/paramspider.git $HOME/tools/paramspider
        cd $HOME/tools/paramspider
        pip3 install . --user || pip3 install --user -e . || echo "paramspider installation had issues"
        # Create wrapper as fallback
        if ! command -v paramspider &> /dev/null; then
          echo '#!/bin/bash' | sudo tee /usr/local/bin/paramspider
          echo "python3 -m paramspider \"\$@\"" | sudo tee -a /usr/local/bin/paramspider
          sudo chmod +x /usr/local/bin/paramspider
        fi
    - name: Install ghauri (from GitHub - FIXED REPOSITORY)
      run: |
        echo "Installing ghauri from GitHub (r0oth3x49 repo)..."
        git clone --depth 1 https://github.com/r0oth3x49/ghauri.git $HOME/tools/ghauri
        cd $HOME/tools/ghauri
        pip3 install -r requirements.txt --user || true
        python3 -m pip install -e . --user || python3 setup.py install --user || true
        if ! command -v ghauri &> /dev/null; then
          echo '#!/bin/bash' | sudo tee /usr/local/bin/ghauri
          echo "cd $HOME/tools/ghauri && python3 -m ghauri \"\$@\"" | sudo tee -a /usr/local/bin/ghauri
          sudo chmod +x /usr/local/bin/ghauri
        fi
    - name: Install phpggc (from GitHub)
      run: |
        echo "Installing phpggc from GitHub..."
        git clone --depth 1 https://github.com/ambionics/phpggc.git $HOME/tools/phpggc
        chmod +x $HOME/tools/phpggc/phpggc || true
        echo '#!/bin/bash' | sudo tee /usr/local/bin/phpggc
        echo "cd $HOME/tools/phpggc && php ./phpggc \"\$@\"" | sudo tee -a /usr/local/bin/phpggc
        sudo chmod +x /usr/local/bin/phpggc
    - name: Install JWT Tool (from GitHub)
      run: |
        echo "Installing JWT Tool..."
        git clone --depth 1 https://github.com/ticarpi/jwt_tool.git $HOME/tools/jwt_tool
        cd $HOME/tools/jwt_tool
        pip3 install -r requirements.txt --user || true
        echo '#!/bin/bash' | sudo tee /usr/local/bin/jwt_tool
        echo "cd $HOME/tools/jwt_tool && python3 jwt_tool.py \"\$@\"" | sudo tee -a /usr/local/bin/jwt_tool
        sudo chmod +x /usr/local/bin/jwt_tool
    - name: Install TruffleHog v3 (Binary - FIXED)
      run: |
        echo "Installing TruffleHog..."
        # Get the latest release URL dynamically
        TRUFFLEHOG_URL=$(curl -s https://api.github.com/repos/trufflesecurity/trufflehog/releases/latest | grep "browser_download_url.*linux_amd64.tar.gz" | head -1 | cut -d '"' -f 4)
        if [ -n "$TRUFFLEHOG_URL" ]; then
          curl -sL "$TRUFFLEHOG_URL" -o trufflehog.tar.gz
          tar -xzf trufflehog.tar.gz
          chmod +x trufflehog
          sudo mv trufflehog /usr/local/bin/
          rm -f trufflehog.tar.gz
        else
          echo "Could not find trufflehog release, skipping"
        fi
    - name: Install GraphQLMap (from GitHub)
      run: |
        echo "Installing GraphQLMap..."
        git clone --depth 1 https://github.com/swisskyrepo/GraphQLmap.git $HOME/tools/GraphQLmap
        cd $HOME/tools/GraphQLmap
        pip3 install -r requirements.txt --user || true
        echo '#!/bin/bash' | sudo tee /usr/local/bin/graphqlmap
        echo "cd $HOME/tools/GraphQLmap && python3 graphqlmap.py \"\$@\"" | sudo tee -a /usr/local/bin/graphqlmap
        sudo chmod +x /usr/local/bin/graphqlmap
    - name: Install inql
      run: |
        echo "Installing inql..."
        pip3 install inql --user || true
        if ! command -v inql &> /dev/null; then
          echo '#!/bin/bash' | sudo tee /usr/local/bin/inql
          echo 'python3 -c "from inql.cli import main; main()" "$@"' | sudo tee -a /usr/local/bin/inql
          sudo chmod +x /usr/local/bin/inql
        fi
    - name: Install Jaeles
      run: |
        echo "Installing Jaeles..."
        export PATH=$PATH:$HOME/go/bin:/usr/local/go/bin
        go install github.com/jaeles-project/jaeles@latest
        sudo cp $HOME/go/bin/jaeles /usr/local/bin/ || true
        mkdir -p $HOME/.jaeles
        jaeles config init || true
        git clone --depth 1 https://github.com/jaeles-project/jaeles-signatures.git $HOME/.jaeles/signatures-base || true
    - name: Download additional precompiled binaries
      run: |
        echo "Downloading precompiled binaries..."
        
        # gitleaks
        GITLEAKS_URL=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep "browser_download_url.*linux_x64.tar.gz" | head -1 | cut -d '"' -f 4)
        if [ -n "$GITLEAKS_URL" ]; then
          curl -sL "$GITLEAKS_URL" -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz
          chmod +x gitleaks 2>/dev/null || true
          sudo mv gitleaks /usr/local/bin/ 2>/dev/null || true
          rm -f gitleaks.tar.gz
        fi
        
        # Feroxbuster
        FEROX_URL=$(curl -s https://api.github.com/repos/epi052/feroxbuster/releases/latest | grep "browser_download_url.*x86_64-linux-musl.tar.gz" | head -1 | cut -d '"' -f 4)
        if [ -n "$FEROX_URL" ]; then
          curl -sL "$FEROX_URL" -o feroxbuster.tar.gz
          tar -xzf feroxbuster.tar.gz
          chmod +x feroxbuster
          sudo mv feroxbuster /usr/local/bin/
          rm -f feroxbuster.tar.gz
        fi
    - name: Install SQLMap (from GitHub)
      run: |
        echo "Installing SQLMap..."
        git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git $HOME/tools/sqlmap
        echo '#!/bin/bash' | sudo tee /usr/local/bin/sqlmap
        echo "python3 $HOME/tools/sqlmap/sqlmap.py \"\$@\"" | sudo tee -a /usr/local/bin/sqlmap
        sudo chmod +x /usr/local/bin/sqlmap
    - name: Install XXEinjector (from GitHub)
      run: |
        echo "Installing XXEinjector..."
        git clone --depth 1 https://github.com/enjoiz/XXEinjector.git $HOME/tools/XXEinjector
        echo '#!/bin/bash' | sudo tee /usr/local/bin/xxeinjector
        echo "cd $HOME/tools/XXEinjector && ruby XXEinjector.rb \"\$@\"" | sudo tee -a /usr/local/bin/xxeinjector
        sudo chmod +x /usr/local/bin/xxeinjector
    - name: Install ppmap (from GitHub)
      run: |
        echo "Installing ppmap..."
        git clone --depth 1 https://github.com/kleiton0x00/ppmap.git $HOME/tools/ppmap
        cd $HOME/tools/ppmap
        pip3 install -r requirements.txt --user || true
        echo '#!/bin/bash' | sudo tee /usr/local/bin/ppmap
        echo "cd $HOME/tools/ppmap && python3 ppmap.py \"\$@\"" | sudo tee -a /usr/local/bin/ppmap
        sudo chmod +x /usr/local/bin/ppmap
    - name: Create Google Drive uploader
      run: |
        echo "Creating Google Drive uploader..."
        cat << 'EOF' > drive_upload.py
        import os, sys
        from google.oauth2.credentials import Credentials
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        def upload(file_path, folder_name):
            try:
                required_vars = ["GOOGLE_REFRESH_TOKEN", "GOOGLE_CLIENT_ID", "GOOGLE_CLIENT_SECRET", "GDRIVE_FOLDER_ID"]
                missing = [v for v in required_vars if not os.environ.get(v)]
                if missing:
                    print(f"ERROR: Missing required env vars: {missing}")
                    print("Please configure these secrets in your GitHub repository")
                    return False
                    
                creds = Credentials(None,
                    refresh_token=os.environ["GOOGLE_REFRESH_TOKEN"],
                    token_uri="https://oauth2.googleapis.com/token",
                    client_id=os.environ["GOOGLE_CLIENT_ID"],
                    client_secret=os.environ["GOOGLE_CLIENT_SECRET"])
                service = build("drive","v3",credentials=creds)
                query = f"name='{folder_name}' and '{os.environ['GDRIVE_FOLDER_ID']}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"
                res = service.files().list(q=query).execute().get("files",[])
                if res:
                    folder_id = res[0]["id"]
                else:
                    folder = service.files().create(
                        body={"name":folder_name,"mimeType":"application/vnd.google-apps.folder","parents":[os.environ["GDRIVE_FOLDER_ID"]]},
                        fields="id").execute()
                    folder_id = folder["id"]
                media = MediaFileUpload(file_path)
                uploaded = service.files().create(body={"name":os.path.basename(file_path),"parents":[folder_id]},media_body=media,fields="id").execute()
                print(f"SUCCESS: Uploaded {file_path} to {folder_name} (ID: {uploaded.get('id')})")
                return True
            except Exception as e:
                print(f"ERROR: Google Drive upload failed: {e}")
                return False
        if __name__ == "__main__":
            if len(sys.argv) >= 3:
                success = upload(sys.argv[1], sys.argv[2])
                sys.exit(0 if success else 1)
            else:
                print("Usage: python3 drive_upload.py <file_path> <folder_name>")
                sys.exit(1)
        EOF
        pip3 install google-api-python-client google-auth-httplib2 google-auth-oauthlib --user
    - name: Setup resolvers for puredns
      run: |
        echo "Setting up DNS resolvers..."
        cat << 'EOF' > /tmp/resolvers.txt
        1.1.1.1
        8.8.8.8
        9.9.9.9
        8.8.4.4
        1.0.0.1
        208.67.222.222
        208.67.220.220
        EOF
    - name: Verify tool installations
      run: |
        echo "Verifying tool installations..."
        echo "-----------------------------------"
        which subfinder && subfinder -version || echo "subfinder: NOT FOUND"
        which httpx && httpx -version || echo "httpx: NOT FOUND"
        which nuclei && nuclei -version || echo "nuclei: NOT FOUND"
        which katana && katana -version || echo "katana: NOT FOUND"
        which gowitness && gowitness version || echo "gowitness: NOT FOUND"
        which massdns || echo "massdns: NOT FOUND"
        which puredns || echo "puredns: NOT FOUND"
        which sqlmap || echo "sqlmap: NOT FOUND"
        which x8 || echo "x8: NOT FOUND"
        which feroxbuster || echo "feroxbuster: NOT FOUND"
        which gitleaks || echo "gitleaks: NOT FOUND"
        which trufflehog || echo "trufflehog: NOT FOUND"
        echo "-----------------------------------"
        echo "Tool verification complete"
    - name: Run ARES pipeline
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        PDCP_API_KEY: ${{ secrets.PDCP_API_KEY }}
      run: |
        if [ ! -f targets.txt ]; then
          echo "example.com" > targets.txt
        fi
        
        TARGET=$(head -n 1 targets.txt)
        echo "=========================================="
        echo "ARES Pipeline - Target: $TARGET"
        echo "=========================================="
        # Telegram notification function
        tg() {
          local message="$1"
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d parse_mode="Markdown" \
              -d text="$message" > /dev/null 2>&1 || true
          fi
          echo "[TG] $message"
        }
        tg "üöÄ *ARES Pipeline Started* on \`$TARGET\`"
        # Run stage with error handling
        run_stage() {
          local stage_name=$1
          local stage_command=$2
          
          echo ""
          echo "========================================"
          echo "üìç STAGE: $stage_name"
          echo "========================================"
          
          set +e
          eval "$stage_command"
          local exit_code=$?
          set -e
          
          if [ $exit_code -eq 0 ]; then
            echo "‚úÖ $stage_name completed"
            tg "‚úÖ $stage_name completed"
          else
            echo "‚ö†Ô∏è $stage_name had issues (exit: $exit_code)"
            tg "‚ö†Ô∏è $stage_name had issues"
          fi
          return 0
        }
        ### STAGE 1: RECON
        run_stage "Stage 1: Reconnaissance" '
          echo "Running subfinder..."
          timeout 300 subfinder -d $TARGET -silent > output/recon/subs.txt 2>/dev/null || true
          
          echo "Running assetfinder..."
          timeout 300 assetfinder --subs-only $TARGET >> output/recon/subs.txt 2>/dev/null || true
          
          if [ -n "$PDCP_API_KEY" ]; then
            echo "Running chaos..."
            timeout 300 chaos -d $TARGET -silent >> output/recon/subs.txt 2>/dev/null || true
          else
            echo "Skipping chaos - no API key" >> output/recon/chaos_skipped.txt
          fi
          
          sort -u output/recon/subs.txt > output/recon/final_subs.txt 2>/dev/null || touch output/recon/final_subs.txt
          echo "Found $(wc -l < output/recon/final_subs.txt) unique subdomains"
          
          if [ -s output/recon/final_subs.txt ]; then
            echo "Running dnsx..."
            timeout 300 dnsx -l output/recon/final_subs.txt -silent > output/recon/dnsx.txt 2>/dev/null || true
            
            echo "Running puredns..."
            timeout 300 puredns resolve output/recon/final_subs.txt -r /tmp/resolvers.txt > output/recon/puredns.txt 2>/dev/null || true
          fi
          
          zip -r recon.zip output/recon/ || true
          python3 drive_upload.py recon.zip Stage_1_Recon
        '
        ### STAGE 2: PROBING
        run_stage "Stage 2: Probing" '
          if [ -s output/recon/final_subs.txt ]; then
            echo "Running httpx..."
            timeout 600 httpx -l output/recon/final_subs.txt -silent > output/probe/live.txt 2>/dev/null || true
            echo "Live hosts: $(wc -l < output/probe/live.txt 2>/dev/null || echo 0)"
            
            if [ -s output/probe/live.txt ]; then
              head -5 output/probe/live.txt > output/probe/live_limited.txt
              mkdir -p output/probe/screenshots/
              # FIXED: gowitness v3 uses "scan file" instead of just "file"
              echo "Running gowitness..."
              timeout 300 gowitness scan file -f output/probe/live_limited.txt --screenshot-path output/probe/screenshots/ 2>/dev/null || \
              timeout 300 gowitness file -f output/probe/live_limited.txt -o output/probe/screenshots/ --no-db 2>/dev/null || true
            fi
          else
            echo "No subdomains found" > output/probe/no_input.txt
          fi
          
          zip -r probe.zip output/probe/ || true
          python3 drive_upload.py probe.zip Stage_2_Probe
        '
        ### STAGE 3: CRAWLING
        run_stage "Stage 3: Crawling" '
          if [ -s output/probe/live.txt ]; then
            echo "Running katana..."
            timeout 600 katana -l output/probe/live.txt -silent > output/crawl/katana.txt 2>/dev/null || true
            
            echo "Running gospider..."
            mkdir -p output/crawl/gospider/
            timeout 600 gospider -S output/probe/live.txt -o output/crawl/gospider/ 2>/dev/null || true
            find output/crawl/gospider/ -type f -name "*.txt" -exec cat {} \; > output/crawl/gospider_combined.txt 2>/dev/null || true
            
            echo "Running paramspider..."
            timeout 300 paramspider -d $TARGET -o output/crawl/paramspider.txt 2>/dev/null || true
            
            if command -v feroxbuster &> /dev/null; then
              echo "Running feroxbuster (limited)..."
              head -2 output/probe/live.txt 2>/dev/null | while read url; do
                timeout 180 feroxbuster -u "$url" -o "output/crawl/feroxbuster_$(echo $url | md5sum | cut -c1-8).txt" --rate-limit 10 -t 3 -q 2>/dev/null || true
              done
            fi
            
            grep "=" output/crawl/katana.txt > output/crawl/params_only.txt 2>/dev/null || touch output/crawl/params_only.txt
            echo "Parameterized URLs: $(wc -l < output/crawl/params_only.txt 2>/dev/null || echo 0)"
          else
            echo "No live hosts" > output/crawl/no_input.txt
          fi
          
          zip -r crawl.zip output/crawl/ || true
          python3 drive_upload.py crawl.zip Stage_3_Crawl
        '
        ### STAGE 4: PARAMS & XSS
        run_stage "Stage 4: Parameter Discovery" '
          if [ -s output/crawl/katana.txt ]; then
            echo "Running qsreplace..."
            cat output/crawl/katana.txt | qsreplace "FUZZ" > output/crawl/qsreplace.txt 2>/dev/null || true
            
            echo "Running kxss..."
            cat output/crawl/katana.txt | kxss > output/crawl/kxss.txt 2>/dev/null || true
            
            echo "Running unfurl..."
            cat output/crawl/katana.txt | unfurl paths keys values > output/crawl/unfurl.txt 2>/dev/null || true
          fi
          
          if [ -s output/probe/live.txt ] && command -v x8 &> /dev/null; then
            echo "Running x8..."
            head -2 output/probe/live.txt 2>/dev/null | while read url; do
              timeout 300 x8 -u "$url" -w /usr/share/wordlists/common.txt -o "output/crawl/x8_$(echo $url | md5sum | cut -c1-8).txt" 2>/dev/null || true
            done
          fi
          
          zip -r params.zip output/crawl/ || true
          python3 drive_upload.py params.zip Stage_4_Params
        '
        ### STAGE 5: VULNS
        run_stage "Stage 5: Vulnerability Scanning" '
          if [ -s output/probe/live.txt ]; then
            echo "Running nuclei..."
            timeout 1800 nuclei -l output/probe/live.txt -severity high,critical -o output/vulns/nuclei.txt 2>/dev/null || true
          fi
          
          if [ -s output/crawl/katana.txt ]; then
            echo "Running dalfox..."
            timeout 1800 dalfox file output/crawl/katana.txt --skip-bav -o output/vulns/dalfox.txt 2>/dev/null || true
          fi
          
          if [ -s output/probe/live.txt ] && command -v ffuf &> /dev/null; then
            echo "Running ffuf..."
            head -2 output/probe/live.txt 2>/dev/null | while read url; do
              timeout 300 ffuf -u "$url/FUZZ" -w /usr/share/wordlists/common.txt -o "output/vulns/ffuf_$(echo $url | md5sum | cut -c1-8).json" -rate 10 -t 3 2>/dev/null || true
            done
          fi
          
          zip -r vulns.zip output/vulns/ || true
          python3 drive_upload.py vulns.zip Stage_5_Vulns
        '
        ### STAGE 6: SECRETS
        run_stage "Stage 6: Secrets Detection" '
          echo "Running trufflehog..."
          timeout 600 trufflehog filesystem . --no-update > output/secrets/trufflehog.txt 2>/dev/null || true
          
          if command -v gitleaks &> /dev/null; then
            echo "Running gitleaks..."
            timeout 300 gitleaks detect --no-git -v > output/secrets/gitleaks.txt 2>&1 || true
          fi
          
          echo "Running git-secrets..."
          git-secrets --scan > output/secrets/git_secrets.txt 2>&1 || true
          
          zip -r secrets.zip output/secrets/ || true
          python3 drive_upload.py secrets.zip Stage_6_Secrets
        '
        ### STAGE 7: GRAPHQL & API
        run_stage "Stage 7: GraphQL & API" '
          echo "https://$TARGET/graphql" > output/graphql/endpoints.txt
          echo "https://$TARGET/api/graphql" >> output/graphql/endpoints.txt
          echo "https://api.$TARGET/graphql" >> output/graphql/endpoints.txt
          
          while read endpoint; do
            [ -n "$endpoint" ] || continue
            echo "Testing $endpoint..."
            timeout 60 graphqlmap -u "$endpoint" -v >> output/graphql/graphqlmap.txt 2>&1 || true
            timeout 60 inql -t "$endpoint" >> output/graphql/inql.txt 2>&1 || true
          done < output/graphql/endpoints.txt
          
          echo "https://$TARGET/swagger.json" > output/api/swagger_endpoints.txt
          echo "https://$TARGET/api-docs" >> output/api/swagger_endpoints.txt
          
          zip -r graphql_api.zip output/graphql/ output/api/ || true
          python3 drive_upload.py graphql_api.zip Stage_7_GraphQL_API
        '
        ### STAGE 8: CLOUD
        run_stage "Stage 8: Cloud Security" '
          echo "provider \"aws\" {}" > test.tf
          echo "resource \"aws_s3_bucket\" \"test\" {}" >> test.tf
          
          timeout 300 tfsec . > output/cloud/tfsec.txt 2>&1 || true
          timeout 300 checkov -d . > output/cloud/checkov.txt 2>&1 || true
          
          rm -f test.tf
          zip -r cloud.zip output/cloud/ || true
          python3 drive_upload.py cloud.zip Stage_8_Cloud
        '
        ### STAGE 9: JWT
        run_stage "Stage 9: JWT Testing" '
          echo "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIn0.dozjgNryP4J3jVmNHl0w5N_XgL0n3I9PlFUP0THsR8U" > output/specialized/sample_jwt.txt
          timeout 120 jwt_tool $(cat output/specialized/sample_jwt.txt) > output/specialized/jwt_tool.txt 2>&1 || true
          
          zip -r specialized.zip output/specialized/ || true
          python3 drive_upload.py specialized.zip Stage_9_JWT
        '
        ### STAGE 10: JAELES
        run_stage "Stage 10: Jaeles" '
          if [ -s output/crawl/katana.txt ]; then
            timeout 1800 jaeles scan -s $HOME/.jaeles/signatures-base -L output/crawl/katana.txt -c 5 -o output/specialized/jaeles.txt 2>/dev/null || true
          else
            echo "No URLs for Jaeles" > output/specialized/jaeles.txt
          fi
          
          zip -r jaeles.zip output/specialized/ || true
          python3 drive_upload.py jaeles.zip Stage_10_Jaeles
        '
        ### STAGE 11: SQL
        run_stage "Stage 11: SQL Injection" '
          mkdir -p output/sql
          if [ -s output/crawl/params_only.txt ]; then
            head -5 output/crawl/params_only.txt > output/sql/params_for_sql.txt
            
            echo "Running sqlmap..."
            timeout 900 sqlmap -m output/sql/params_for_sql.txt --batch --risk 1 --level 1 --technique=BEU --delay=5 --threads=2 --timeout=30 > output/sql/sqlmap_results.txt 2>&1 || true
            
            echo "Running ghauri..."
            head -3 output/crawl/params_only.txt | while read url; do
              [ -n "$url" ] || continue
              timeout 300 ghauri -u "$url" --batch --delay 5 --timeout 30 > "output/sql/ghauri_$(echo $url | md5sum | cut -c1-8).txt" 2>&1 || true
            done
          else
            echo "No parameterized URLs" > output/sql/no_params.txt
          fi
          
          zip -r sql.zip output/sql/ || true
          python3 drive_upload.py sql.zip Stage_11_SQL
        '
        ### STAGE 12: NoSQL
        run_stage "Stage 12: NoSQL" '
          mkdir -p output/nosql
          echo "NoSQL testing requires manual analysis (NoSQLMap needs Python2)" > output/nosql/info.txt
          
          zip -r nosql.zip output/nosql/ || true
          python3 drive_upload.py nosql.zip Stage_12_NoSQL
        '
        ### STAGE 13: COMMAND INJECTION
        run_stage "Stage 13: Command Injection" '
          mkdir -p output/templates
          if [ -s output/crawl/params_only.txt ]; then
            head -3 output/crawl/params_only.txt | while read url; do
              [ -n "$url" ] || continue
              timeout 300 commix -u "$url" --batch --delay 5 --technique=classic > "output/templates/commix_$(echo $url | md5sum | cut -c1-8).txt" 2>&1 || true
            done
          else
            echo "No parameterized URLs" > output/templates/no_params.txt
          fi
          
          zip -r templates.zip output/templates/ || true
          python3 drive_upload.py templates.zip Stage_13_CommandInjection
        '
        ### STAGE 14: XXE
        run_stage "Stage 14: XXE" '
          mkdir -p output/xxe
          echo "XXE testing requires manual identification of XML endpoints" > output/xxe/info.txt
          
          if [ -s output/crawl/katana.txt ]; then
            grep -i "\.xml\|application/xml" output/crawl/katana.txt > output/xxe/xml_endpoints.txt 2>/dev/null || touch output/xxe/xml_endpoints.txt
          fi
          
          zip -r xxe.zip output/xxe/ || true
          python3 drive_upload.py xxe.zip Stage_14_XXE
        '
        ### STAGE 15: AUTH
        run_stage "Stage 15: Authentication" '
          mkdir -p output/auth
          if [ -s output/crawl/katana.txt ]; then
            grep -i "login\|auth\|signin\|password" output/crawl/katana.txt > output/auth/auth_endpoints.txt 2>/dev/null || touch output/auth/auth_endpoints.txt
          fi
          
          timeout 60 interactsh-client -v > output/auth/interactsh.txt 2>&1 || true
          
          zip -r auth.zip output/auth/ || true
          python3 drive_upload.py auth.zip Stage_15_Auth
        '
        ### STAGE 16: DESERIALIZATION
        run_stage "Stage 16: Deserialization" '
          mkdir -p output/deserialization
          phpggc --list > output/deserialization/phpggc_list.txt 2>&1 || true
          
          if [ -s output/crawl/katana.txt ]; then
            grep -i "serialize\|pickle\|yaml" output/crawl/katana.txt > output/deserialization/endpoints.txt 2>/dev/null || touch output/deserialization/endpoints.txt
          fi
          
          zip -r deserialization.zip output/deserialization/ || true
          python3 drive_upload.py deserialization.zip Stage_16_Deserialization
        '
        echo ""
        echo "=========================================="
        echo "üèÅ ARES Pipeline COMPLETED on $TARGET"
        echo "=========================================="
        tg "üèÅ *ARES Pipeline COMPLETED* on \`$TARGET\` - All 16 stages executed"
    - name: Cleanup - Delete all local data
      if: always()
      run: |
        echo "Cleaning up all local data..."
        rm -rf output/ *.zip drive_upload.py test.tf 2>/dev/null || true
        rm -rf $HOME/tools/ $HOME/SecLists/ $HOME/.jaeles/ 2>/dev/null || true
        rm -rf $HOME/go/bin/* $HOME/.cargo/registry/ 2>/dev/null || true
        echo "‚úÖ Cleanup complete - all data deleted from GitHub runner"
        echo "üìÅ Your results are safely stored in Google Drive"
